<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°m S√°t NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi - Sandbox</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/device.css">
    <link rel="stylesheet" href="/css/energy-flow.css">
    <link rel="stylesheet" href="/css/console.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-solar-panel"></i> Gi√°m S√°t NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</h1>
                <div class="status-indicator">
                    <span class="status-label">Tr·ª±c ti·∫øp Sandbox:</span>
                    <span id="connection-status" class="status-dot offline"></span>
                    <span id="connection-text">ƒêang k·∫øt n·ªëi...</span>
                </div>
            </div>
        </header>

        <div class="input-section">
            <div class="input-container">
                <div class="input-group">
                    <label for="deviceIdInput" class="input-label">
                        <i class="fas fa-microchip"></i> Device ID
                    </label>
                    <input type="text" id="deviceIdInput" class="device-input" placeholder="Nh·∫≠p Device ID..." value="P250801055">
                    <button id="viewBtn" class="view-btn">
                        <i class="fas fa-eye"></i> Xem
                    </button>
                </div>
                <div class="input-info">
                    <i class="fas fa-info-circle"></i>
                    <span>S·ª≠ d·ª•ng tr·ª±c ti·∫øp sandbox URL: https://7000-ivivi5yaau15busmciwnu-c81df28e.sandbox.novita.ai</span>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ sandbox...</p>
        </div>

        <div id="error" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-text"></span>
            <button class="retry-btn" onclick="location.reload()">
                <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
            </button>
        </div>

        <div id="main-content" class="main-content" style="display: none;">
            <!-- Realtime Data Section -->
            <section class="realtime-section">
                <h2><i class="fas fa-bolt"></i> D·ªØ Li·ªáu Th·ªùi Gian Th·ª±c</h2>
                
                <div class="realtime-grid">
                    <div class="realtime-card">
                        <div class="card-header">
                            <i class="fas fa-battery-three-quarters"></i>
                            <span>PIN</span>
                        </div>
                        <div class="card-value" id="battery-soc">--</div>
                        <div class="card-unit">%</div>
                    </div>
                    
                    <div class="realtime-card">
                        <div class="card-header">
                            <i class="fas fa-solar-panel"></i>
                            <span>NƒÇNG L∆Ø·ª¢NG M·∫∂T TR·ªúI</span>
                        </div>
                        <div class="card-value" id="pv-power">--</div>
                        <div class="card-unit">W</div>
                    </div>
                    
                    <div class="realtime-card">
                        <div class="card-header">
                            <i class="fas fa-home"></i>
                            <span>T·∫¢I TI√äU TH·ª§</span>
                        </div>
                        <div class="card-value" id="load-power">--</div>
                        <div class="card-unit">W</div>
                    </div>
                    
                    <div class="realtime-card">
                        <div class="card-header">
                            <i class="fas fa-plug"></i>
                            <span>L∆Ø·ªöI ƒêI·ªÜN</span>
                        </div>
                        <div class="card-value" id="grid-power">--</div>
                        <div class="card-unit">W</div>
                    </div>
                </div>
            </section>

            <!-- Battery Cells -->
            <section class="battery-cells-section">
                <h2><i class="fas fa-battery-half"></i> Tr·∫°ng Th√°i T·ª´ng Cell Pin</h2>
                <div id="battery-cells" class="battery-cells-grid"></div>
            </section>

            <!-- Energy Flow -->
            <section class="energy-flow-section">
                <h2><i class="fas fa-exchange-alt"></i> Lu·ªìng NƒÉng L∆∞·ª£ng</h2>
                <div class="energy-flow-container">
                    <div class="energy-source pv">
                        <i class="fas fa-solar-panel"></i>
                        <span>NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</span>
                        <div class="power-value" id="pv-flow">0W</div>
                    </div>
                    
                    <div class="energy-flow-arrows">
                        <div class="arrow pv-to-load"></div>
                        <div class="arrow pv-to-battery"></div>
                        <div class="arrow battery-to-load"></div>
                        <div class="arrow grid-to-load"></div>
                        <div class="arrow pv-to-grid"></div>
                    </div>
                    
                    <div class="energy-destination battery">
                        <i class="fas fa-battery-three-quarters"></i>
                        <span>Pin L∆∞u Tr·ªØ</span>
                        <div class="power-value" id="battery-flow">0W</div>
                    </div>
                    
                    <div class="energy-destination load">
                        <i class="fas fa-home"></i>
                        <span>T·∫£i Ti√™u Th·ª•</span>
                        <div class="power-value" id="load-flow">0W</div>
                    </div>
                    
                    <div class="energy-source-grid">
                        <i class="fas fa-plug"></i>
                        <span>L∆∞·ªõi ƒêi·ªán</span>
                        <div class="power-value" id="grid-flow">0W</div>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-section">
                <h2><i class="fas fa-chart-line"></i> Bi·ªÉu ƒê·ªì SOC</h2>
                <div class="chart-container">
                    <canvas id="socChart"></canvas>
                </div>
            </section>

            <!-- Console -->
            <section class="console-section">
                <h2><i class="fas fa-terminal"></i> Console</h2>
                <div class="console-container">
                    <div id="console" class="console-output"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Configuration - s·ª≠ d·ª•ng sandbox URL tr·ª±c ti·∫øp
        const CONFIG = {
            SANDBOX_URL: 'https://7000-ivivi5yaau15busmciwnu-c81df28e.sandbox.novita.ai',
            API_ENDPOINT: '/api/proxy/realtime',
            SOC_ENDPOINT: '/api/proxy/soc',
            SIGNALR_HUB: '/realtimeHub'
        };

        // Override fetch functions ƒë·ªÉ s·ª≠ d·ª•ng sandbox URL
        window.fetchData = async function(deviceId, date) {
            console.log(`üîÑ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ sandbox: ${CONFIG.SANDBOX_URL}${CONFIG.API_ENDPOINT}/${deviceId}`);
            
            try {
                showLoading();
                hideError();
                
                // G·ªçi tr·ª±c ti·∫øp sandbox URL
                const realtimeUrl = `${CONFIG.SANDBOX_URL}${CONFIG.API_ENDPOINT}/${deviceId}`;
                const response = await fetch(realtimeUrl);
                
                if (!response.ok) {
                    throw new Error(`L·ªói khi g·ªçi sandbox: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log("‚úÖ D·ªØ li·ªáu t·ª´ sandbox:", data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Hi·ªÉn th·ªã d·ªØ li·ªáu
                displayRealtimeData(data);
                
                // ·∫®n loading v√† hi·ªÉn th·ªã n·ªôi dung ch√≠nh
                hideLoading();
                document.getElementById('main-content').style.display = 'block';
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                hideLoading();
                showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ sandbox: ${error.message}`);
                updateConnectionStatus(false);
            }
        };

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            if (connected) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'ƒê√£ k·∫øt n·ªëi sandbox';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'M·∫•t k·∫øt n·ªëi';
            }
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu realtime
        function displayRealtimeData(data) {
            if (data && data.data) {
                const realtimeData = data.data;
                
                // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã
                updateValue('battery-soc', formatValue(realtimeData.batterySoc, 1), '%');
                updateValue('pv-power', formatValue(realtimeData.pvPower, 0), 'W');
                updateValue('load-power', formatValue(realtimeData.loadPower, 0), 'W');
                updateValue('grid-power', formatValue(realtimeData.gridPower, 0), 'W');
                
                // C·∫≠p nh·∫≠t lu·ªìng nƒÉng l∆∞·ª£ng
                updateEnergyFlow(realtimeData);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i pin
                updateBatteryStatus(realtimeData);
                
                console.log(`‚úÖ C·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng - Pin: ${realtimeData.batterySoc}%`);
            }
        }

        // Format gi√° tr·ªã
        function formatValue(value, decimals = 0) {
            if (value === null || value === undefined) return '--';
            return parseFloat(value).toFixed(decimals);
        }

        // C·∫≠p nh·∫≠t lu·ªìng nƒÉng l∆∞·ª£ng
        function updateEnergyFlow(data) {
            const pvPower = data.pvPower || 0;
            const batteryPower = data.batteryPower || 0;
            const loadPower = data.loadPower || 0;
            const gridPower = data.gridPower || 0;
            
            document.getElementById('pv-flow').textContent = `${Math.abs(pvPower)}W`;
            document.getElementById('battery-flow').textContent = `${Math.abs(batteryPower)}W`;
            document.getElementById('load-flow').textContent = `${Math.abs(loadPower)}W`;
            document.getElementById('grid-flow').textContent = `${Math.abs(gridPower)}W`;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i m≈©i t√™n
            updateFlowArrows(pvPower, batteryPower, loadPower, gridPower);
        }

        // C·∫≠p nh·∫≠t m≈©i t√™n lu·ªìng
        function updateFlowArrows(pvPower, batteryPower, loadPower, gridPower) {
            const arrows = document.querySelectorAll('.arrow');
            arrows.forEach(arrow => arrow.classList.remove('active'));
            
            if (pvPower > 0) {
                document.querySelector('.pv-to-load').classList.add('active');
                if (batteryPower < 0) {
                    document.querySelector('.pv-to-battery').classList.add('active');
                }
                if (gridPower < 0) {
                    document.querySelector('.pv-to-grid').classList.add('active');
                }
            }
            
            if (batteryPower > 0) {
                document.querySelector('.battery-to-load').classList.add('active');
            }
            
            if (gridPower > 0) {
                document.querySelector('.grid-to-load').classList.add('active');
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i pin
        function updateBatteryStatus(data) {
            const batterySoc = data.batterySoc || 0;
            const batteryVoltage = data.batteryVoltage || 0;
            const batteryCurrent = data.batteryCurrent || 0;
            
            // C·∫≠p nh·∫≠t SOC
            const socElement = document.getElementById('battery-soc');
            if (socElement) {
                socElement.textContent = formatValue(batterySoc, 1);
            }
            
            // Hi·ªÉn th·ªã th√™m th√¥ng tin pin n·∫øu c√≥
            console.log(`üîã Pin: ${batterySoc}%, ${batteryVoltage}V, ${batteryCurrent}A`);
        }

        // C·∫≠p nh·∫≠t gi√° tr·ªã v·ªõi hi·ªáu ·ª©ng nh·∫•p nh√°y
        function updateValue(elementId, value, unit = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.classList.add('updated');
                setTimeout(() => element.classList.remove('updated'), 500);
            }
        }

        // Hi·ªÉn th·ªã loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // ·∫®n loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Hi·ªÉn th·ªã l·ªói
        function showError(message) {
            const errorElement = document.getElementById('error');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorElement.style.display = 'block';
        }

        // ·∫®n l·ªói
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Console logging
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            console.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // Override console methods
        console.log = function(message) { logToConsole(message, 'info'); };
        console.error = function(message) { logToConsole(message, 'error'); };
        console.warn = function(message) { logToConsole(message, 'warning'); };

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ·ª®ng d·ª•ng gi√°m s√°t nƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi - S·ª≠ d·ª•ng Sandbox URL');
            console.log(`üì° Sandbox URL: ${CONFIG.SANDBOX_URL}`);
            
            // G√°n s·ª± ki·ªán cho n√∫t Xem
            const viewBtn = document.getElementById('viewBtn');
            const deviceIdInput = document.getElementById('deviceIdInput');
            
            viewBtn.addEventListener('click', function() {
                const deviceId = deviceIdInput.value.trim();
                if (deviceId) {
                    fetchData(deviceId, new Date().toISOString().split('T')[0]);
                } else {
                    showError('Vui l√≤ng nh·∫≠p Device ID');
                }
            });
            
            // Enter key support
            deviceIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    viewBtn.click();
                }
            });
            
            // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu n·∫øu c√≥ deviceId trong URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlDeviceId = urlParams.get('deviceId');
            if (urlDeviceId) {
                deviceIdInput.value = urlDeviceId;
                setTimeout(() => fetchData(urlDeviceId, new Date().toISOString().split('T')[0]), 1000);
            }
        });
    </script>
</body>
</html>