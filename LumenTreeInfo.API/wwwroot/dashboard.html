<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gi√°m S√°t NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/css/index.css" rel="stylesheet" />
    
    <style>
        body { zoom: 0.9; }
        #cellGrid .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        @media (min-width: 640px) { #cellGrid .grid { grid-template-columns: repeat(8, 1fr); gap: 8px; } }
        .cell-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px 4px; border-radius: 8px; min-height: 50px; transition: all 0.3s ease; }
        .cell-item .cell-label { font-size: 9px; font-weight: 600; opacity: 0.8; }
        .cell-item .cell-voltage { font-size: 11px; font-weight: 700; font-family: 'SF Mono', monospace; }
        @media (min-width: 640px) { .cell-item { min-height: 60px; } .cell-item .cell-label { font-size: 10px; } .cell-item .cell-voltage { font-size: 12px; } }
        .cell-good { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .cell-ok { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .cell-warning { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .value-updated { animation: flash 0.5s ease-out; }
        @keyframes flash { 0% { background-color: rgba(139, 92, 246, 0.4); } 100% { background-color: transparent; } }
        .cell-blink { animation: cellBlink 0.5s ease-out; }
        @keyframes cellBlink { 0% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.8); transform: scale(1.03); } 100% { box-shadow: none; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen">
    <div class="container mx-auto px-2 sm:px-4 py-2 sm:py-4 max-w-6xl">
        
        <!-- Header -->
        <div class="mb-4 bg-white dark:bg-slate-800 rounded-xl shadow-lg p-3 border border-slate-200 dark:border-slate-700">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-3">
                    <img src="/logo.png" alt="Logo" class="w-10 h-10 rounded-lg shadow">
                    <div>
                        <h1 class="text-lg font-bold bg-gradient-to-r from-cyan-500 via-violet-500 to-pink-500 bg-clip-text text-transparent">
                            ‚ö° Gi√°m S√°t NƒÉng L∆∞·ª£ng
                        </h1>
                        <div class="flex items-center gap-2 text-xs text-slate-500">
                            <span id="deviceIdDisplay" class="font-semibold">--</span>
                            <span>‚Ä¢</span>
                            <span id="deviceLocation">--</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1 px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-xs font-medium text-emerald-700 dark:text-emerald-400">Auto 2s</span>
                    </div>
                    <button id="settingsBtn" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600" title="C√†i ƒë·∫∑t">
                        <i data-lucide="settings" class="w-4 h-4 text-slate-600 dark:text-slate-300"></i>
                    </button>
                </div>
            </div>
            
            <!-- Settings Panel (hidden by default) -->
            <div id="settingsPanel" class="hidden mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-grow">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">Device ID</label>
                        <input type="text" id="deviceId" value="P250801055" class="w-full px-3 py-2 text-sm border-2 border-slate-200 dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white">
                    </div>
                    <div class="flex-grow">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">Realtime API</label>
                        <input type="text" id="apiUrl" value="https://solar-proxy.applike098.workers.dev/api/realtime" class="w-full px-3 py-2 text-sm border-2 border-slate-200 dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white">
                    </div>
                    <div class="flex-grow">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">SOC History API</label>
                        <input type="text" id="socApiUrl" value="https://solar-proxy.applike098.workers.dev/api/soc" class="w-full px-3 py-2 text-sm border-2 border-slate-200 dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white">
                    </div>
                    <div class="flex items-end">
                        <button id="applyBtn" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 font-semibold text-sm">√Åp d·ª•ng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time Energy Flow -->
        <div class="mb-4">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-3 border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-slate-800 dark:text-white flex items-center gap-1.5">
                        <i data-lucide="activity" class="w-4 h-4 text-green-500"></i>
                        Lu·ªìng NƒÉng L∆∞·ª£ng Th·ªùi Gian Th·ª±c
                    </h2>
                    <div class="flex items-center gap-2 text-[10px] text-slate-500">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        <span id="energyUpdateTime">--:--:--</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 sm:gap-3">
                    <!-- T·∫•m Pin -->
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl p-2.5 sm:p-3 border border-amber-200 dark:border-amber-800">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5"><img src="/icons/solar-panel.png" alt="T·∫•m Pin" class="w-full h-full object-contain"></div>
                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-300">T·∫•m Pin</div>
                            <div class="text-base sm:text-lg font-black text-amber-600 dark:text-amber-400" id="pv-power">--</div>
                            <div class="text-[10px] text-slate-500" id="pv-desc">--</div>
                        </div>
                    </div>
                    
                    <!-- Inverter -->
                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-xl p-2.5 sm:p-3 border border-cyan-200 dark:border-cyan-800">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5"><img src="/icons/inverter.png" alt="Inverter" class="w-full h-full object-contain"></div>
                            <div class="text-xs font-bold text-cyan-700 dark:text-cyan-300">Lumentree</div>
                            <div class="text-xs font-medium text-slate-500" id="device-temp">--</div>
                        </div>
                    </div>
                    
                    <!-- L∆∞·ªõi EVN -->
                    <div class="bg-gradient-to-br from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 rounded-xl p-2.5 sm:p-3 border border-orange-200 dark:border-orange-800">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5"><img src="/icons/evn-grid.png" alt="L∆∞·ªõi EVN" class="w-full h-full object-contain"></div>
                            <div class="text-xs font-semibold text-orange-700 dark:text-orange-300">L∆∞·ªõi EVN</div>
                            <div class="text-base sm:text-lg font-black text-orange-600 dark:text-orange-400" id="grid-power">--</div>
                            <div class="text-[10px] text-slate-500" id="grid-voltage">--</div>
                        </div>
                    </div>
                    
                    <!-- Pin -->
                    <div class="bg-gradient-to-br from-slate-50 to-gray-50 dark:from-slate-800 dark:to-gray-800 rounded-xl p-2.5 sm:p-3 border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-8 sm:w-16 sm:h-9 mb-1.5 flex items-center justify-center">
                                <div class="w-12 h-7 sm:w-14 sm:h-8 rounded-md border-2 border-slate-400 relative overflow-hidden bg-white dark:bg-slate-700">
                                    <div id="battery-fill" class="absolute left-0 top-0 bottom-0 bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                    <span id="battery-percent-icon" class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-black text-slate-700 dark:text-white z-10">--%</span>
                                </div>
                                <div class="w-1 h-3 sm:h-4 bg-slate-400 rounded-r-sm"></div>
                            </div>
                            <div class="text-xs font-semibold text-slate-600 dark:text-slate-300">Pin</div>
                            <div id="battery-power" class="text-base sm:text-lg font-black text-slate-700 dark:text-slate-300">--</div>
                            <div id="battery-status-text" class="text-xs font-medium text-slate-500">--</div>
                        </div>
                    </div>
                    
                    <!-- T·∫£i c·ªïng load -->
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-xl p-2.5 sm:p-3 border border-indigo-200 dark:border-indigo-800">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5"><img src="/icons/backup.png" alt="T·∫£i c·ªïng load" class="w-full h-full object-contain"></div>
                            <div class="text-xs font-semibold text-indigo-700 dark:text-indigo-300">T·∫£i c·ªïng load</div>
                            <div class="text-base sm:text-lg font-black text-indigo-600 dark:text-indigo-400" id="essential-power">--</div>
                        </div>
                    </div>
                    
                    <!-- T·∫£i h√≤a l∆∞·ªõi -->
                    <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-xl p-2.5 sm:p-3 border border-emerald-200 dark:border-emerald-800">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5"><img src="/icons/load.png" alt="T·∫£i h√≤a l∆∞·ªõi" class="w-full h-full object-contain"></div>
                            <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-300">T·∫£i h√≤a l∆∞·ªõi</div>
                            <div class="text-base sm:text-lg font-black text-emerald-600 dark:text-emerald-400" id="load-power">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battery Cell Section -->
        <div class="mb-4">
            <div class="bg-white dark:bg-slate-800 rounded-xl border-2 border-teal-200 dark:border-teal-800 shadow-lg overflow-hidden">
                <div class="p-3 bg-gradient-to-r from-teal-50 to-cyan-50 dark:from-teal-900/30 dark:to-cyan-900/30 border-b border-teal-200 dark:border-teal-800">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-9 h-9 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                                <i data-lucide="battery" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-sm font-bold text-slate-800 dark:text-white">ƒêi·ªán √Åp Cell Pin</h2>
                                <p class="text-[10px] text-teal-600 dark:text-teal-400 font-medium">Gi√°m s√°t t·ª´ng cell</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="cellCountBadge" class="bg-teal-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">-- cell</span>
                            <div class="flex items-center gap-1 text-[10px] text-slate-500">
                                <i data-lucide="clock" class="w-3 h-3"></i>
                                <span id="cellUpdateTime">--:--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-3">
                    <div class="grid grid-cols-5 gap-2 mb-3">
                        <div class="bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-lg p-2 text-center border border-blue-200 dark:border-blue-700">
                            <div class="text-[8px] font-bold text-blue-600 dark:text-blue-400 uppercase">ƒêi·ªán √Åp Pin</div>
                            <div class="text-sm sm:text-lg font-black text-blue-700 dark:text-blue-300" id="batteryVoltageDisplay">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-teal-100 to-cyan-100 dark:from-teal-900/40 dark:to-cyan-900/40 rounded-lg p-2 text-center border border-teal-200 dark:border-teal-700">
                            <div class="text-[8px] font-bold text-teal-600 dark:text-teal-400 uppercase">Trung B√¨nh</div>
                            <div class="text-sm sm:text-lg font-black text-teal-700 dark:text-teal-300" id="cellAvg">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/40 dark:to-emerald-900/40 rounded-lg p-2 text-center border border-green-200 dark:border-green-700">
                            <div class="text-[8px] font-bold text-green-600 dark:text-green-400 uppercase">Cao Nh·∫•t</div>
                            <div class="text-sm sm:text-lg font-black text-green-700 dark:text-green-300" id="cellMax">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-100 to-yellow-100 dark:from-amber-900/40 dark:to-yellow-900/40 rounded-lg p-2 text-center border border-amber-200 dark:border-amber-700">
                            <div class="text-[8px] font-bold text-amber-600 dark:text-amber-400 uppercase">Th·∫•p Nh·∫•t</div>
                            <div class="text-sm sm:text-lg font-black text-amber-700 dark:text-amber-300" id="cellMin">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-rose-100 to-red-100 dark:from-rose-900/40 dark:to-red-900/40 rounded-lg p-2 text-center border border-rose-200 dark:border-rose-700">
                            <div class="text-[8px] font-bold text-rose-600 dark:text-rose-400 uppercase">ƒê·ªô L·ªách</div>
                            <div class="text-sm sm:text-lg font-black" id="cellDiffValue">--</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-2 sm:p-3 border border-slate-200 dark:border-slate-700">
                        <div id="cellGrid">
                            <div class="flex items-center justify-center h-16 text-slate-400 text-xs">
                                <i data-lucide="loader" class="w-4 h-4 animate-spin mr-2"></i>
                                ƒêang t·∫£i d·ªØ li·ªáu...
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center justify-center gap-3 mt-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-green-400 to-green-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">T·ªët (&lt;0.020V)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-amber-400 to-amber-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">Kh√° (0.020-0.050V)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-red-400 to-red-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">C·∫£nh b√°o (&gt;0.050V)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Day Summary - T·ªïng k·∫øt ng√†y -->
        <div class="mb-4">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-3 border-2 border-violet-200 dark:border-violet-800">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-slate-800 dark:text-white flex items-center gap-1.5">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-violet-500"></i>
                        T·ªïng K·∫øt Ng√†y
                    </h2>
                    <div class="flex items-center gap-2 text-[10px] text-slate-500">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        <span id="daySummaryUpdateTime">--:--:--</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-lg p-2 text-center border border-amber-200 dark:border-amber-700">
                        <div class="text-[8px] font-bold text-amber-600 dark:text-amber-400 uppercase">PV S·∫£n Xu·∫•t</div>
                        <div class="text-sm font-black text-amber-700 dark:text-amber-300" id="day-pv">--</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-lg p-2 text-center border border-emerald-200 dark:border-emerald-700">
                        <div class="text-[8px] font-bold text-emerald-600 dark:text-emerald-400 uppercase">T·∫£i Ti√™u Th·ª•</div>
                        <div class="text-sm font-black text-emerald-700 dark:text-emerald-300" id="day-load">--</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-lg p-2 text-center border border-orange-200 dark:border-orange-700">
                        <div class="text-[8px] font-bold text-orange-600 dark:text-orange-400 uppercase">L∆∞·ªõi EVN</div>
                        <div class="text-sm font-black text-orange-700 dark:text-orange-300" id="day-grid">--</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 rounded-lg p-2 text-center border border-green-200 dark:border-green-700">
                        <div class="text-[8px] font-bold text-green-600 dark:text-green-400 uppercase">Pin N·∫°p</div>
                        <div class="text-sm font-black text-green-700 dark:text-green-300" id="day-bat-charge">--</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20 rounded-lg p-2 text-center border border-red-200 dark:border-red-700">
                        <div class="text-[8px] font-bold text-red-600 dark:text-red-400 uppercase">Pin X·∫£</div>
                        <div class="text-sm font-black text-red-700 dark:text-red-300" id="day-bat-discharge">--</div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-lg p-2 text-center border border-indigo-200 dark:border-indigo-700">
                        <div class="text-[8px] font-bold text-indigo-600 dark:text-indigo-400 uppercase">D·ª± Ph√≤ng</div>
                        <div class="text-sm font-black text-indigo-700 dark:text-indigo-300" id="day-backup">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOC Chart -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-3 sm:p-4 border-2 border-emerald-200 dark:border-emerald-800 mb-4">
            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                <h2 class="text-sm font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i data-lucide="battery-full" class="w-4 h-4 text-emerald-500"></i>
                    Ph·∫ßn TrƒÉm Pin (SOC)
                </h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="socDate" class="px-2 py-1 text-xs border border-slate-300 dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white">
                    <button id="loadSocBtn" class="px-2 py-1 bg-emerald-500 text-white text-xs rounded-lg hover:bg-emerald-600 font-medium">T·∫£i</button>
                    <div class="flex items-center gap-1 text-[10px] text-emerald-600 dark:text-emerald-400">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span id="socStatus">--</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-3">
                <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg p-2 text-center">
                    <div class="text-[8px] font-bold text-emerald-600 uppercase">Hi·ªán T·∫°i</div>
                    <div class="text-sm font-black text-emerald-700 dark:text-emerald-300" id="soc-current">--%</div>
                </div>
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-2 text-center">
                    <div class="text-[8px] font-bold text-green-600 uppercase">Cao Nh·∫•t</div>
                    <div class="text-sm font-black text-green-700 dark:text-green-300" id="soc-max">--%</div>
                </div>
                <div class="bg-amber-50 dark:bg-amber-900/30 rounded-lg p-2 text-center">
                    <div class="text-[8px] font-bold text-amber-600 uppercase">Th·∫•p Nh·∫•t</div>
                    <div class="text-sm font-black text-amber-700 dark:text-amber-300" id="soc-min">--%</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-2 text-center">
                    <div class="text-[8px] font-bold text-blue-600 uppercase">ƒêi·ªÉm D·ªØ Li·ªáu</div>
                    <div class="text-sm font-black text-blue-700 dark:text-blue-300" id="soc-count">--</div>
                </div>
            </div>
            <div style="height: 220px;"><canvas id="socChart"></canvas></div>
        </div>

        <!-- Error -->
        <div id="errorMessage" class="hidden bg-red-50 dark:bg-red-900/20 border-2 border-red-300 text-red-700 dark:text-red-400 px-4 py-3 rounded-xl mb-4">
            <i data-lucide="alert-circle" class="w-5 h-5 inline mr-2"></i>
            <span id="errorText">L·ªói k·∫øt n·ªëi</span>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // Config
        const REFRESH_INTERVAL = 2000; // 2 seconds
        const SOC_API_BASE = 'https://solar-proxy.applike098.workers.dev/api/soc';
        
        // State
        let refreshTimer = null;
        let socChart = null;
        let socHistory = [];      // History from API
        let socRealtime = null;   // Current realtime SOC
        let prevValues = {};
        let prevCells = {};
        let socDataLoaded = false;

        // Get URL params
        const urlParams = new URLSearchParams(window.location.search);
        const urlDeviceId = urlParams.get('deviceId');
        if (urlDeviceId) document.getElementById('deviceId').value = urlDeviceId;

        // Settings toggle
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        });

        document.getElementById('applyBtn').addEventListener('click', () => {
            const deviceId = document.getElementById('deviceId').value.trim();
            if (deviceId) {
                const url = new URL(window.location);
                url.searchParams.set('deviceId', deviceId);
                window.history.pushState({}, '', url);
                document.getElementById('settingsPanel').classList.add('hidden');
            }
        });

        // Utility functions
        function updateValue(id, value) {
            const el = document.getElementById(id);
            if (el) {
                const newVal = String(value);
                if (prevValues[id] !== newVal) {
                    el.textContent = value;
                    el.classList.remove('value-updated');
                    void el.offsetWidth;
                    el.classList.add('value-updated');
                    prevValues[id] = newVal;
                }
            }
        }

        function updateHTML(id, html) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = html;
        }

        function getTimeString() {
            return new Date().toLocaleTimeString('vi-VN');
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Fetch Day Summary - T·ªïng k·∫øt ng√†y (m·ªói 2s)
        async function fetchDaySummary() {
            const deviceId = document.getElementById('deviceId').value.trim();
            if (!deviceId) return;

            const today = new Date().toISOString().split('T')[0];
            const dayApiUrl = `https://solar-proxy.applike098.workers.dev/api/day/${deviceId}/${today}`;
            
            try {
                console.log('üìä Fetching Day Summary:', dayApiUrl);
                const res = await fetch(dayApiUrl);
                if (!res.ok) return;
                
                const data = await res.json();
                if (data.error) return;

                // Update day summary display
                const now = getTimeString();
                updateValue('daySummaryUpdateTime', now);

                if (data.summary) {
                    const s = data.summary;
                    updateValue('day-pv', `${(s.pv_day || 0).toFixed(1)} kWh`);
                    updateValue('day-load', `${(s.load_day || 0).toFixed(1)} kWh`);
                    updateValue('day-grid', `${(s.grid_day || 0).toFixed(1)} kWh`);
                    updateValue('day-backup', `${(s.backup_day || 0).toFixed(1)} kWh`);
                    
                    // Battery charge/discharge from bat_raw
                    if (data.bat_raw?.bats) {
                        const charge = (data.bat_raw.bats[0]?.tableValue || 0) / 10;
                        const discharge = (data.bat_raw.bats[1]?.tableValue || 0) / 10;
                        updateValue('day-bat-charge', `${charge.toFixed(1)} kWh`);
                        updateValue('day-bat-discharge', `${discharge.toFixed(1)} kWh`);
                    } else {
                        const batNet = s.bat_day || 0;
                        if (batNet >= 0) {
                            updateValue('day-bat-charge', `${batNet.toFixed(1)} kWh`);
                            updateValue('day-bat-discharge', '0.0 kWh');
                        } else {
                            updateValue('day-bat-charge', '0.0 kWh');
                            updateValue('day-bat-discharge', `${Math.abs(batNet).toFixed(1)} kWh`);
                        }
                    }
                    console.log('‚úÖ Day summary updated:', s);
                }
            } catch (err) {
                console.warn('Day summary fetch error:', err);
            }
        }

        // Fetch data
        async function fetchData() {
            const deviceId = document.getElementById('deviceId').value.trim();
            let baseUrl = document.getElementById('apiUrl').value.trim().replace(/\/+$/, '');
            
            if (!deviceId) return;

            // Build API URL - append deviceId to the base URL
            const apiUrl = `${baseUrl}/${deviceId}`;
            console.log('üì° Fetching:', apiUrl);

            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                hideError();
                displayData(data);
                
                // Also fetch day summary every refresh
                fetchDaySummary();

            } catch (err) {
                console.error('Fetch error:', err);
                showError(`L·ªói: ${err.message}`);
            }
        }

        // Display data
        function displayData(data) {
            const d = data.data || {};
            const cells = data.cells || {};
            const now = getTimeString();

            // Header info
            document.getElementById('deviceIdDisplay').textContent = data.device_id || document.getElementById('deviceId').value || '--';
            document.getElementById('deviceLocation').textContent = data.city || '--';

            // Update timestamps
            document.getElementById('energyUpdateTime').textContent = now;
            document.getElementById('cellUpdateTime').textContent = now;

            // PV
            const pvTotal = d.totalPvPower || (d.pv1Power || 0) + (d.pv2Power || 0);
            updateValue('pv-power', `${pvTotal}W`);
            updateValue('pv-desc', d.pv2Power ? `S1: ${d.pv1Power}W | S2: ${d.pv2Power}W` : `${d.pv1Voltage || 0}V`);

            // Grid
            updateValue('grid-power', `${Math.abs(d.gridPowerFlow || 0)}W`);
            updateValue('grid-voltage', `${d.acInputVoltage || 0}V`);

            // Battery
            const soc = d.batterySoc || 0;
            updateValue('battery-percent-icon', `${soc}%`);
            
            const fill = document.getElementById('battery-fill');
            if (fill) {
                fill.style.width = `${soc}%`;
                fill.className = `absolute left-0 top-0 bottom-0 transition-all duration-500 ${soc <= 20 ? 'bg-red-500' : soc <= 50 ? 'bg-yellow-500' : 'bg-green-500'}`;
            }

            const power = d.batteryPower || 0;
            const status = d.batteryStatus || 'Idle';
            
            if (status === "Discharging") {
                updateHTML('battery-power', `<span class="text-red-600">-${Math.abs(power)}W</span>`);
                updateHTML('battery-status-text', `<span class="text-red-500">ƒêang x·∫£</span>`);
            } else if (status === "Charging") {
                updateHTML('battery-power', `<span class="text-green-600">+${Math.abs(power)}W</span>`);
                updateHTML('battery-status-text', `<span class="text-green-500">ƒêang s·∫°c</span>`);
            } else {
                updateHTML('battery-power', `<span class="text-slate-600">${power}W</span>`);
                updateHTML('battery-status-text', `<span class="text-slate-500">Ch·ªù</span>`);
            }

            // Other
            updateValue('essential-power', `${d.acOutputPower || 0}W`);
            updateValue('load-power', `${d.homeLoad || 0}W`);
            updateValue('device-temp', `${d.temperature || 0}¬∞C`);
            updateValue('batteryVoltageDisplay', `${(d.batteryVoltage || 0).toFixed(1)}V`);

            // Cells
            displayCells(cells);

            // SOC Chart - update realtime
            updateRealtimeSOC(soc);
        }

        // Display cells - H·ªó tr·ª£ c·∫£ 2 ƒë·ªãnh d·∫°ng: Object {"Cell 01": 3.223} v√† Array [3.223, 3.224]
        function displayCells(cellsData) {
            const grid = document.getElementById('cellGrid');
            
            if (!cellsData?.cellVoltages) {
                grid.innerHTML = `<div class="flex items-center justify-center h-16 text-slate-400 text-xs">Kh√¥ng c√≥ d·ªØ li·ªáu cell</div>`;
                return;
            }

            const rawVoltages = cellsData.cellVoltages;
            
            // Convert to normalized format: [{name: "Cell 01", voltage: 3.223}, ...]
            let voltageList = [];
            
            if (Array.isArray(rawVoltages)) {
                // Format t·ª´ Workers: [3.413, 3.379, ...]
                voltageList = rawVoltages.map((v, i) => ({
                    name: `Cell ${String(i + 1).padStart(2, '0')}`,
                    voltage: v
                }));
            } else if (typeof rawVoltages === 'object') {
                // Format t·ª´ Sandbox: {"Cell 01": 3.223, ...}
                voltageList = Object.entries(rawVoltages)
                    .sort((a, b) => parseInt(a[0].replace(/\D/g, '')) - parseInt(b[0].replace(/\D/g, '')))
                    .map(([name, voltage]) => ({ name, voltage }));
            }

            if (voltageList.length === 0) {
                grid.innerHTML = `<div class="flex items-center justify-center h-16 text-slate-400 text-xs">Kh√¥ng c√≥ d·ªØ li·ªáu cell</div>`;
                return;
            }

            // Calculate stats (t·ª± t√≠nh n·∫øu API kh√¥ng tr·∫£ v·ªÅ)
            const voltageValues = voltageList.map(c => c.voltage);
            const avg = cellsData.averageVoltage || (voltageValues.reduce((a, b) => a + b, 0) / voltageValues.length);
            const max = cellsData.maximumVoltage || Math.max(...voltageValues);
            const min = cellsData.minimumVoltage || Math.min(...voltageValues);
            const diff = cellsData.voltageDifference || (max - min);
            const num = cellsData.numberOfCells || voltageList.length;

            // Stats - ƒê·ªô l·ªách hi·ªÉn th·ªã b·∫±ng V (3 s·ªë th·∫≠p ph√¢n)
            updateValue('cellAvg', `${avg.toFixed(3)}V`);
            updateValue('cellMax', `${max.toFixed(3)}V`);
            updateValue('cellMin', `${min.toFixed(3)}V`);
            updateValue('cellDiffValue', `${diff.toFixed(3)}V`);
            updateValue('cellCountBadge', `${num} cell`);

            // Diff color
            const diffEl = document.getElementById('cellDiffValue');
            if (diffEl) {
                diffEl.className = 'text-sm sm:text-lg font-black ' + 
                    (diff > 0.05 ? 'text-red-600' : diff > 0.02 ? 'text-amber-600' : 'text-green-600');
            }

            // Build grid
            let html = '<div class="grid">';
            voltageList.forEach((cell, i) => {
                const key = `cell_${i}`;
                const changed = prevCells[key] !== undefined && prevCells[key] !== cell.voltage;
                prevCells[key] = cell.voltage;

                const dev = Math.abs(cell.voltage - avg);
                const color = dev < 0.02 ? 'cell-good' : dev < 0.05 ? 'cell-ok' : 'cell-warning';
                const blink = changed ? 'cell-blink' : '';

                html += `<div class="cell-item ${color} ${blink}">
                    <span class="cell-label">${cell.name}</span>
                    <span class="cell-voltage">${cell.voltage.toFixed(3)}V</span>
                </div>`;
            });
            html += '</div>';
            grid.innerHTML = html;
        }

        // ===== SOC CHART WITH HISTORY API =====
        
        // Fetch SOC history from API
        async function fetchSOCHistory(date) {
            const deviceId = document.getElementById('deviceId').value.trim();
            let socApiBase = document.getElementById('socApiUrl').value.trim().replace(/\/+$/, '');
            
            if (!deviceId || !date) return;
            
            const apiUrl = `${socApiBase}/${deviceId}/${date}`;
            console.log('üìä Fetching SOC history:', apiUrl);
            
            document.getElementById('socStatus').textContent = 'ƒêang t·∫£i...';
            
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                
                if (data.timeline && Array.isArray(data.timeline)) {
                    socHistory = data.timeline.map(item => ({
                        time: item.t,
                        soc: item.soc
                    }));
                    socDataLoaded = true;
                    document.getElementById('socStatus').textContent = `${date}`;
                    console.log(`‚úÖ Loaded ${socHistory.length} SOC data points`);
                    renderSOCChart();
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (err) {
                console.error('SOC fetch error:', err);
                document.getElementById('socStatus').textContent = 'L·ªói t·∫£i';
            }
        }
        
        // Update realtime SOC (called from displayData)
        function updateRealtimeSOC(soc) {
            socRealtime = soc;
            updateValue('soc-current', `${soc}%`);
            
            // If we have history data, update the chart with current point
            if (socDataLoaded && socHistory.length > 0) {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                // Check if current time is after last history point
                const lastHistoryTime = socHistory[socHistory.length - 1].time;
                if (currentTime > lastHistoryTime) {
                    // Add realtime point if not already added
                    const lastPoint = socHistory[socHistory.length - 1];
                    if (lastPoint.time !== currentTime) {
                        // Keep only history data + current realtime
                        const historyOnly = socHistory.filter(p => !p.isRealtime);
                        socHistory = [...historyOnly, { time: currentTime, soc, isRealtime: true }];
                    } else if (lastPoint.isRealtime) {
                        lastPoint.soc = soc;
                    }
                    renderSOCChart();
                }
            } else if (!socDataLoaded) {
                // No history loaded yet, just show current
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                if (socHistory.length === 0 || socHistory[socHistory.length - 1].time !== currentTime) {
                    socHistory.push({ time: currentTime, soc });
                    if (socHistory.length > 50) socHistory.shift();
                }
                renderSOCChart();
            }
        }
        
        // Render SOC Chart
        function renderSOCChart() {
            const ctx = document.getElementById('socChart');
            if (!ctx || socHistory.length === 0) return;
            
            const labels = socHistory.map(i => i.time);
            const values = socHistory.map(i => i.soc);
            
            // Update stats
            const validValues = values.filter(v => v != null && !isNaN(v));
            if (validValues.length > 0) {
                updateValue('soc-max', `${Math.max(...validValues).toFixed(1)}%`);
                updateValue('soc-min', `${Math.min(...validValues).toFixed(1)}%`);
                updateValue('soc-count', validValues.length);
            }
            
            if (socChart) {
                socChart.data.labels = labels;
                socChart.data.datasets[0].data = values;
                socChart.update('none');
            } else {
                socChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'SOC %',
                            data: values,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `SOC: ${ctx.raw.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                min: 0, 
                                max: 100, 
                                ticks: { 
                                    callback: v => v + '%',
                                    stepSize: 20
                                },
                                grid: { color: 'rgba(100,100,100,0.1)' }
                            },
                            x: { 
                                ticks: { 
                                    maxRotation: 0, 
                                    autoSkip: true,
                                    maxTicksLimit: 12
                                }, 
                                grid: { display: false } 
                            }
                        }
                    }
                });
            }
        }
        
        // Load SOC button click
        document.getElementById('loadSocBtn').addEventListener('click', () => {
            const date = document.getElementById('socDate').value;
            if (date) {
                fetchSOCHistory(date);
            }
        });
        
        // Set default date to today
        function setDefaultSOCDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('socDate').value = dateStr;
            // Auto-load today's data
            fetchSOCHistory(dateStr);
        }

        // ===== AUTO START ON PAGE LOAD =====
        function startAutoRefresh() {
            console.log('üöÄ Auto refresh started (every 2s)');
            fetchData(); // Fetch immediately
            refreshTimer = setInterval(fetchData, REFRESH_INTERVAL);
        }

        // Start automatically when page loads
        window.addEventListener('DOMContentLoaded', () => {
            setDefaultSOCDate(); // Load today's SOC history
            startAutoRefresh();
        });
    </script>
</body>
</html>
