<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh To√°n Ti·∫øt Ki·ªám ƒêi·ªán M·∫∑t Tr·ªùi</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="·ª®ng d·ª•ng t√≠nh to√°n v√† theo d√µi hi·ªáu qu·∫£ ti·∫øt ki·ªám chi ph√≠ t·ª´ h·ªá th·ªëng nƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi">
    <meta name="theme-color" content="#4ade80">
    <!-- PWA disabled - use browser shortcut instead -->
    <!-- <meta name="mobile-web-app-capable" content="yes"> -->
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <!-- <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> -->
    <!-- <meta name="apple-mobile-web-app-title" content="Solar Calculator"> -->
    
    <!-- PWA Manifest disabled -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 40, 60, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .header-subtitle {
            color: #a0aec0;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .storage-info {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid #8b5cf6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .storage-info strong {
            color: #c4b5fd;
        }

        .evn-calculator-btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1em;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .evn-calculator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .evn-calculator-btn:active {
            transform: translateY(0);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 12px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2);
            transition: all 0.3s ease;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Animated rotating border */
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                transparent,
                transparent,
                #4ade80,
                #22c55e,
                #10b981,
                #059669,
                transparent
            );
            animation: rotate 4s linear infinite;
            z-index: 0;
        }

        /* Inner content layer */
        .card::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 8px;
            z-index: 1;
        }

        /* Hover effect */
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
        }

        .card:hover::before {
            animation: rotate 2s linear infinite;
        }

        .card:hover .value {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Pulse animation for values */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .card h3 {
            font-size: 0.7em;
            color: #a0aec0;
            margin-bottom: 6px;
            line-height: 1.2;
            position: relative;
            z-index: 2;
        }

        .card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #4ade80;
            line-height: 1.2;
            position: relative;
            z-index: 2;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        /* Rotating animation */
        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* All cards use green color - Simple and clean */

        .input-section {
            background: rgba(45, 55, 72, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .input-section h2 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
        }

        .price-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        /* Quick Stats Dashboard */
        .quick-stats {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 2px solid rgba(16, 185, 129, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
        }
        
        .quick-stats h2 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        /* Stat cards - Gi·ªëng Summary Cards nh∆∞ng KH√îNG c√≥ animation */
        .stat-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 12px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2);
            transition: all 0.3s ease;
        }
        
        /* NO animated border (kh√°c v·ªõi .card) */
        
        /* Inner content - Gi·ªëng .card */
        .stat-card h4 {
            font-size: 0.7em;
            color: #a0aec0;
            margin-bottom: 6px;
            line-height: 1.2;
            position: relative;
            z-index: 2;
        }
        
        .stat-card .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #4ade80;
            line-height: 1.2;
            position: relative;
            z-index: 2;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }
        
        .stat-card .stat-label {
            font-size: 0.7em;
            color: #a0aec0;
            margin-top: 2px;
            position: relative;
            z-index: 2;
        }
        
        /* Hover effect - Gi·ªëng .card nh∆∞ng kh√¥ng c√≥ animation */
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .stat-trend.up {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        .stat-trend.down {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .stat-trend.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #d1d5db;
        }

        .investment-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.15) 100%);
            border: 2px solid #8b5cf6;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }

        .investment-section h2 {
            color: #c4b5fd;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .investment-config {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .investment-input-wrapper {
            background: rgba(45, 55, 72, 0.8);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .investment-input-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd);
        }

        .investment-input-wrapper label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e7ff;
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .investment-input-wrapper label::before {
            content: 'üí∞';
            font-size: 1.3em;
        }

        .investment-input-wrapper input[type="text"] {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.4em;
            border: 2px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            background: rgba(45, 55, 72, 0.8);
            color: #fff;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .investment-input-wrapper input[type="text"]:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2), inset 0 2px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .investment-input-wrapper .tooltip {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 15px;
            font-size: 0.85em;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .investment-input-wrapper .tooltip::before {
            content: 'üí°';
            font-size: 1.2em;
        }



        .roi-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 2px solid rgba(124, 58, 237, 0.3);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(10px);
        }

        .roi-section h2 {
            color: #e0e7ff;
            margin-bottom: 20px;
            font-size: 1.4em;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* ROI Input Row */
        .roi-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .roi-input-row label {
            color: #a78bfa;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            margin: 0;
        }

        .roi-input-row input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.8);
            color: #fff;
            font-size: 1em;
            font-weight: 600;
        }

        .roi-input-row input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .roi-calc-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .roi-calc-btn:hover {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .roi-calc-btn:active {
            transform: translateY(0);
        }

        /* ROI Progress Section */
        .roi-progress-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .roi-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .roi-progress-title {
            color: #c4b5fd;
            font-weight: 600;
            font-size: 0.95em;
        }

        .roi-progress-percent {
            color: #10b981;
            font-weight: 700;
            font-size: 1.3em;
        }

        .roi-progress-bar-wrapper {
            margin-bottom: 8px;
        }

        .roi-progress-bar-bg {
            height: 12px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .roi-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #10b981);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .roi-progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #9ca3af;
        }

        /* ROI Stats Grid */
        .roi-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .roi-stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.15);
            transition: all 0.2s ease;
        }

        .roi-stat-item:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .roi-stat-item.profit-item {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .roi-stat-icon {
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 10px;
        }

        .profit-item .roi-stat-icon {
            background: rgba(16, 185, 129, 0.2);
        }

        .roi-stat-info {
            flex: 1;
            min-width: 0;
        }

        .roi-stat-label {
            font-size: 0.75em;
            color: #9ca3af;
            margin-bottom: 2px;
        }

        .roi-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #e0e7ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .roi-stat-value.profit {
            color: #10b981;
        }

        .roi-stat-note {
            font-size: 0.7em;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Legacy support - hide old elements */
        .roi-cards, .roi-compact-grid, .roi-mini-progress, .roi-progress, .investment-config {
            display: none !important;
        }

        /* Keep old roi-card styles for compatibility */
        .roi-card .roi-value {
            font-size: 1.4em;
            font-weight: 800;
            color: #fff;
            background: linear-gradient(135deg, #f3f4f6, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .roi-card .roi-unit {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 8px;
            font-weight: 500;
        }

        .roi-progress {
            margin-top: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 15px;
            border: 2px solid rgba(139, 92, 246, 0.2);
        }

        .roi-progress-label {
            color: #e0e7ff;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .roi-progress-percentage {
            color: #c4b5fd;
            font-size: 1.3em;
            font-weight: 800;
        }

        .roi-progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .roi-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 800;
            font-size: 0.9em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .roi-progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Mobile ROI Compact Layout - Hidden on desktop by default */
        .roi-compact-input {
            display: none; /* Hidden on desktop */
            align-items: center;
            gap: 10px;
            background: rgba(45, 55, 72, 0.8);
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }
        
        .roi-compact-input label {
            font-size: 0.85em;
            color: #c4b5fd;
            white-space: nowrap;
            font-weight: 600;
        }
        
        .roi-compact-input input {
            flex: 1;
            padding: 10px 12px;
            font-size: 1.1em;
            border: 2px solid rgba(74, 222, 128, 0.3);
            border-radius: 8px;
            background: rgba(26, 32, 44, 0.8);
            color: #fff;
            font-weight: 700;
            min-width: 0;
        }
        
        .roi-compact-grid {
            display: none; /* Hidden on desktop */
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .roi-mini-card {
            background: rgba(30, 41, 59, 0.9);
            padding: 10px;
            border-radius: 10px;
            border-left: 3px solid #8b5cf6;
        }
        
        .roi-mini-card .mini-label {
            font-size: 0.65em;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .roi-mini-card .mini-value {
            font-size: 1.05em;
            font-weight: 700;
            color: #fff;
        }
        
        .roi-mini-card .mini-note {
            font-size: 0.6em;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .roi-mini-card.highlight {
            border-left-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        
        .roi-mini-card.highlight .mini-value {
            color: #4ade80;
        }
        
        .roi-mini-card.profit {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .roi-mini-card.profit .mini-value {
            color: #10b981;
        }
        
        .roi-mini-progress {
            display: none; /* Hidden on desktop */
            background: rgba(30, 41, 59, 0.6);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .roi-mini-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .roi-mini-progress-header .label {
            font-size: 0.75em;
            color: #c4b5fd;
            font-weight: 600;
        }
        
        .roi-mini-progress-header .percent {
            font-size: 1.1em;
            font-weight: 800;
            color: #a78bfa;
        }
        
        .roi-mini-bar {
            width: 100%;
            height: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .roi-mini-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        /* Responsive: Gi·∫£m s·ªë c·ªôt tr√™n m√†n h√¨nh nh·ªè h∆°n */
        @media (max-width: 1800px) {
            .input-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1400px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .pagination-info {
            color: #cbd5e0;
            font-size: 0.9em;
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 6px;
        }

        .month-input {
            background: rgba(26, 32, 44, 0.8);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4a5568;
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .month-input h4 {
            margin: 0;
            color: #4ade80;
            font-size: 0.8em;
            font-weight: 600;
        }

        .month-delete-btn {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
            padding: 0;
            opacity: 0.6;
        }

        .month-delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            color: #fca5a5;
            opacity: 1;
            transform: scale(1.05);
        }

        .month-input:hover .month-delete-btn {
            opacity: 1;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-size: 0.65em;
            color: #cbd5e0;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 6px;
            margin-bottom: 5px;
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 4px;
            background: rgba(45, 55, 72, 0.8);
            color: #fff;
            font-size: 0.8em;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        /* Remove spinner for number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-calculate {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #1a202c;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.4);
        }

        .btn-save {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-load {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-load:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-demo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-demo:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-add-month {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-add-month:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-remove-month {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .btn-remove-month:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(249, 115, 22, 0.4);
        }

        .month-count-info {
            text-align: center;
            padding: 10px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
            color: #c4b5fd;
            font-weight: bold;
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-export-csv {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
        }

        .btn-export-csv:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(20, 184, 166, 0.4);
        }

        .btn-import {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            cursor: pointer;
            display: inline-block;
        }

        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.4);
        }

        .chart-container {
            background: rgba(45, 55, 72, 0.6);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            height: 500px;
        }

        .month-details {
            background: rgba(45, 55, 72, 0.6);
            padding: 25px;
            border-radius: 15px;
        }

        .month-details h2 {
            color: #4ade80;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .details-grid {
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }

        .details-grid.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .details-grid.expanded {
            max-height: 10000px;
            opacity: 1;
        }

        .details-rows-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .details-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        @media (max-width: 1400px) {
            .details-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .details-row {
                grid-template-columns: 1fr;
            }
        }

        .detail-card {
            background: rgba(26, 32, 44, 0.9);
            padding: 8px;
            border-radius: 8px;
            border-left: 3px solid #4ade80;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            font-size: 0.75em;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Hover effect for detail cards */
        .detail-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        /* Xanh l√° - H√†ng ch·∫µn (2, 4, 6, 8, 10, 12) */
        .detail-card:nth-child(2n) {
            background: rgba(34, 197, 94, 0.15);
            border-left: 3px solid #4ade80;
        }

        .detail-card:nth-child(2n):hover {
            background: rgba(34, 197, 94, 0.25);
            box-shadow: 0 12px 30px rgba(74, 222, 128, 0.4);
        }

        /* Xanh d∆∞∆°ng - H√†ng l·∫ª (1, 3, 5, 7, 9, 11) */
        .detail-card:nth-child(2n+1) {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #60a5fa;
        }

        .detail-card:nth-child(2n+1):hover {
            background: rgba(59, 130, 246, 0.25);
            box-shadow: 0 12px 30px rgba(96, 165, 250, 0.4);
        }

        /* Popup tooltip */
        .detail-card-tooltip {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid #4ade80;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        /* Arrow down */
        .detail-card-tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #4ade80;
        }

        /* Show tooltip on hover */
        .detail-card:hover .detail-card-tooltip {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            top: -70px;
        }

        /* Blue tooltip for odd cards */
        .detail-card:nth-child(2n+1) .detail-card-tooltip {
            border-color: #60a5fa;
        }

        .detail-card:nth-child(2n+1) .detail-card-tooltip::after {
            border-top-color: #60a5fa;
        }

        /* Emoji animation in tooltip */
        .detail-card-tooltip .emoji {
            display: inline-block;
            animation: bounce 0.6s ease infinite;
            margin-right: 8px;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* EVN Calculator Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            margin: 20px;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: white;
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            color: #e2e8f0;
        }

        .evn-tier-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .evn-tier-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .evn-tier-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #4a5568;
            background: rgba(45, 55, 72, 0.5);
        }

        .evn-tier-table tr:last-child td {
            border-bottom: none;
        }

        .evn-tier-number {
            font-weight: 600;
            color: #667eea;
        }

        .evn-price {
            font-weight: 600;
            color: #4ade80;
        }

        .evn-input-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(45, 55, 72, 0.6);
            border-radius: 15px;
            border: 2px solid #4a5568;
        }

        .evn-input-section h3 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 1.1em;
        }

        .evn-input-group {
            margin-bottom: 15px;
        }

        .evn-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #cbd5e0;
        }

        .evn-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            font-size: 1em;
            background: rgba(26, 32, 44, 0.8);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }

        .evn-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .evn-btn-calculate {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .evn-btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .evn-result-section {
            display: none;
            margin-top: 25px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.15);
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .evn-result-section.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .evn-breakdown {
            margin-top: 15px;
        }

        .evn-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
            font-size: 0.9em;
        }

        .evn-breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1em;
            color: #4ade80;
            padding-top: 12px;
            margin-top: 8px;
            border-top: 2px solid #4ade80;
        }

        .evn-tier-label {
            color: #cbd5e0;
        }

        .evn-tier-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .evn-final-result {
            font-size: 1.3em;
            font-weight: 700;
            color: #4ade80;
            text-align: center;
            padding: 15px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #4ade80;
        }

        .evn-warning {
            background: rgba(251, 191, 36, 0.15);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .evn-warning strong {
            color: #fbbf24;
        }

        .detail-card h4 {
            color: #4ade80;
            margin-bottom: 6px;
            font-size: 0.95em;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 4px;
            font-weight: bold;
        }

        /* Title m√†u xanh d∆∞∆°ng cho h√†ng l·∫ª */
        .detail-card:nth-child(2n+1) h4 {
            color: #60a5fa;
        }

        .detail-row-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(74, 85, 104, 0.5);
            font-size: 0.95em;
        }

        .detail-row-item:last-child {
            border-bottom: none;
        }

        .detail-row-item.highlight {
            font-weight: bold;
            color: #4ade80;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 2px solid #4ade80;
        }

        /* Highlight xanh d∆∞∆°ng cho card l·∫ª */
        .detail-card:nth-child(2n+1) .detail-row-item.highlight {
            color: #60a5fa;
            border-top-color: #60a5fa;
        }

        .detail-row-item.section-header {
            color: #f59e0b;
            font-weight: bold;
            margin-top: 6px;
            border-bottom: 2px solid #f59e0b;
            padding-bottom: 3px;
        }

        .detail-row-item.grid-cost {
            color: #ef4444;
        }

        .detail-row-item .label {
            color: #cbd5e0;
            font-size: 0.9em;
        }

        .detail-row-item .value {
            color: #fff;
            font-weight: 500;
        }

        .tooltip {
            font-size: 0.75em;
            color: #a0aec0;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #1a202c;
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .auto-save-indicator {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(74, 222, 128, 0.2);
            border-radius: 5px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .auto-save-indicator.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Mobile-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Touch device optimizations */
            button {
                min-height: 44px; /* iOS minimum touch target */
            }

            input[type="number"],
            input[type="text"] {
                min-height: 44px; /* iOS minimum touch target */
            }

            .toggle-btn {
                min-height: 44px;
            }
            
            /* Button group compact on mobile - 3x3 grid */
            .button-group button {
                min-height: 44px;
                padding: 10px 4px;
                font-size: 0.7em;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better touch scrolling on iOS */
        .collapsible-content,
        .details-grid {
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.4em;
                line-height: 1.3;
                text-align: center;
            }

            .header-subtitle {
                font-size: 0.9em;
                line-height: 1.5;
                text-align: center;
            }

            .auto-save-indicator {
                font-size: 0.8em;
                padding: 6px 10px;
            }

            .storage-info {
                padding: 12px 15px;
                font-size: 0.85em;
                margin-bottom: 15px;
                text-align: center;
            }

            /* Summary cards - 2 c·ªôt tr√™n mobile, gi·ªëng Quick Stats */
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .card {
                padding: 10px 8px;
                border-left: 2px solid #4ade80;
            }

            .card h3 {
                font-size: 0.65em;
                margin-bottom: 5px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                line-height: 1.1;
            }

            .card .value {
                font-size: 1em;
                font-weight: 800;
            }
            
            /* Quick Stats - 2 c·ªôt tr√™n mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 10px 8px;
            }
            
            .stat-card h4 {
                font-size: 0.65em;
                margin-bottom: 5px;
            }
            
            .stat-card .stat-value {
                font-size: 1em;
            }
            
            .stat-card .stat-label {
                font-size: 0.65em;
            }

            /* Investment section */
            .investment-section {
                padding: 15px;
            }

            .investment-section h2 {
                font-size: 1.2em;
            }

            .investment-input-wrapper {
                padding: 15px;
            }

            .investment-input-wrapper label {
                font-size: 0.9em;
            }

            .investment-input-wrapper input[type="text"] {
                padding: 12px;
                font-size: 1.1em;
            }

            .config-note {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .note-icon {
                font-size: 1.3em;
            }

            .note-content strong {
                font-size: 1em;
            }

            .note-content ul li {
                font-size: 0.65em;
                line-height: 1.5;
            }

            /* ROI Section - Mobile Compact */
            .roi-section {
                padding: 15px 12px;
            }

            .roi-section h2 {
                font-size: 1.1em;
                margin-bottom: 15px;
                flex-direction: row;
                justify-content: space-between;
            }
            
            .roi-section h2 span:first-child {
                font-size: 0.9em;
            }

            /* ROI Input Row - Mobile */
            .roi-input-row {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px 12px;
            }

            .roi-input-row label {
                width: 100%;
                font-size: 0.85em;
                margin-bottom: 0;
            }

            .roi-input-row input {
                flex: 1;
                min-width: 0;
                padding: 10px 12px;
                font-size: 0.95em;
            }

            .roi-calc-btn {
                padding: 10px 14px;
                font-size: 0.85em;
            }

            /* ROI Stats Grid - Mobile */
            .roi-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .roi-stat-item {
                padding: 10px;
                gap: 8px;
            }

            .roi-stat-icon {
                font-size: 1.2em;
                width: 32px;
                height: 32px;
            }

            .roi-stat-label {
                font-size: 0.65em;
            }

            .roi-stat-value {
                font-size: 0.9em;
            }

            .roi-stat-note {
                font-size: 0.6em;
            }

            /* ROI Progress - Mobile */
            .roi-progress-section {
                padding: 12px;
                margin-bottom: 15px;
            }

            .roi-progress-title {
                font-size: 0.85em;
            }

            .roi-progress-percent {
                font-size: 1.1em;
            }

            .roi-progress-bar-bg {
                height: 10px;
            }

            .roi-progress-labels {
                font-size: 0.65em;
            }

            /* Month Delete Button - Mobile */
            .month-header {
                margin-bottom: 3px;
            }

            .month-delete-btn {
                width: 18px;
                height: 18px;
                font-size: 11px;
                border-radius: 3px;
                opacity: 0.5;
            }

            .month-input:hover .month-delete-btn,
            .month-delete-btn:active {
                opacity: 1;
            }

            /* Input section */
            .input-section {
                padding: 15px;
            }

            .input-section h2 {
                font-size: 1.2em;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .input-section h2 span {
                text-align: center;
            }

            .toggle-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                width: 100%;
            }

            /* Month inputs - 3 c·ªôt tr√™n mobile, si√™u compact */
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .month-input {
                padding: 6px;
                border-left: 2px solid #8b5cf6;
            }

            .month-input h4 {
                font-size: 0.75em;
                margin-bottom: 4px;
                font-weight: 700;
            }

            .month-input label {
                font-size: 0.6em;
                margin-bottom: 2px;
                font-weight: 600;
                display: block;
            }

            .month-input input[type="number"] {
                padding: 6px 4px;
                font-size: 0.8em;
                margin-bottom: 4px;
                font-weight: 600;
                width: 100%;
            }

            /* Buttons - 3 c·ªôt 3 h√†ng, compact */
            .button-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            button {
                width: 100%;
                padding: 10px 8px;
                font-size: 0.7em;
                font-weight: 600;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pagination {
                gap: 8px;
            }

            .pagination button {
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .pagination-info {
                font-size: 0.85em;
                padding: 8px 12px;
            }

            .month-count-info {
                font-size: 0.9em;
                padding: 10px 15px;
            }

            /* Chart - Cao h∆°n tr√™n mobile */
            .chart-container {
                height: 350px;
                margin-bottom: 20px;
            }

            /* Month details - 1 c·ªôt, border tr√°i */
            .month-details h2 {
                font-size: 1.2em;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .month-details h2 span {
                text-align: center;
            }

            .details-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .detail-card {
                padding: 10px;
                font-size: 0.75em;
                border-left: 2px solid #4ade80;
            }

            .detail-card h4 {
                font-size: 0.85em;
                font-weight: 700;
                margin-bottom: 6px;
            }

            .detail-row-item {
                padding: 5px 0;
                font-size: 0.8em;
            }

            .detail-row-item .label {
                font-weight: 600;
            }

            .detail-row-item .value {
                font-weight: 700;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            /* Storage info */
            .storage-info {
                padding: 12px;
                font-size: 0.85em;
            }
        }

        /* Extra small screens (< 400px) */
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.1em;
            }

            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .card {
                padding: 8px 6px;
            }

            .card h3 {
                font-size: 0.6em;
            }

            .card .value {
                font-size: 0.9em;
            }

            .input-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .month-input {
                padding: 6px;
            }

            .month-input h4 {
                font-size: 0.75em;
            }

            .month-input label {
                font-size: 0.6em;
            }

            .month-input input[type="number"] {
                padding: 6px 4px;
                font-size: 0.8em;
            }

            /* ROI compact stays same for extra small */
            .roi-compact-input input {
                font-size: 16px; /* Prevent iOS zoom */
            }

            .details-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .detail-card {
                padding: 8px 6px;
            }

            .month-input input[type="number"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .investment-input-wrapper input[type="text"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Tablet (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .roi-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .roi-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåû T√≠nh To√°n Ti·∫øt Ki·ªám ƒêi·ªán NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</h1>
            <div class="header-subtitle">
                Qu·∫£n l√Ω v√† theo d√µi hi·ªáu qu·∫£ ti·∫øt ki·ªám t·ª´ h·ªá th·ªëng nƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi c·ªßa b·∫°n<br>
                <span class="auto-save-indicator" id="autoSaveIndicator">üíæ L∆∞u t·ª± ƒë·ªông khi b·∫•m L∆∞u C√†i ƒê·∫∑t</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="evn-calculator-btn" onclick="openEVNModal()">
                    ‚ö° T√≠nh Ti·ªÅn ƒêi·ªán EVN
                </button>
                <button class="evn-calculator-btn" onclick="openLumentreeModal()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ‚òÄÔ∏è ƒê·ªìng B·ªô Lumentree
                </button>
            </div>
        </div>

        <div class="storage-info" id="storageInfo">
            <strong>üíæ Tr·∫°ng th√°i l∆∞u tr·ªØ:</strong> <span id="storageStatus">ƒêang t·∫£i...</span>
        </div>

        <!-- Project Overview Section -->
        <div class="quick-stats" id="projectOverview" style="display: block;">
            <h2>
                <span>üìä T·ªïng Qu√°t D·ª± √Ån Solar C·ªßa B·∫°n</span>
                <button class="toggle-btn" onclick="toggleProjectOverview()" id="toggleProjectOverviewBtn">üîº ·∫®n</button>
            </h2>
            <div class="collapsible-content expanded" id="projectOverviewContent">
                <div class="summary-cards">
                    <div class="card">
                        <h3>T·ªïng Ti·∫øt Ki·ªám</h3>
                        <div class="value" id="totalSavings">0 ‚Ç´</div>
                    </div>
                    <div class="card">
                        <h3>T·ªïng ƒêi·ªán Ti√™u Th·ª•<br>(Load)</h3>
                        <div class="value" id="totalLoad">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>T·ªïng ƒêi·ªán Solar<br>S·∫£n Xu·∫•t</h3>
                        <div class="value" id="totalSolar">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>T·ªïng ƒêi·ªán L∆∞·ªõi<br>EVN (Grid)</h3>
                        <div class="value" id="totalGrid">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>Chi Ph√≠ N·∫øu<br>Kh√¥ng C√≥ Solar</h3>
                        <div class="value" id="totalCostWithoutSolar">0 ‚Ç´</div>
                    </div>
                    <div class="card">
                        <h3>Trung B√¨nh<br>Ti·∫øt Ki·ªám/Th√°ng</h3>
                        <div class="value" id="avgSavings">0 ‚Ç´</div>
                    </div>
                    <div class="card">
                        <h3>Trung B√¨nh<br>T·ªïng ƒêi·ªán Ti√™u Th·ª•</h3>
                        <div class="value" id="avgLoad">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>Trung B√¨nh<br>ƒêi·ªán Solar S·∫£n Xu·∫•t</h3>
                        <div class="value" id="avgSolar">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>Trung B√¨nh<br>ƒêi·ªán L∆∞·ªõi EVN</h3>
                        <div class="value" id="avgGrid">0 kWh</div>
                    </div>
                    <div class="card">
                        <h3>Trung B√¨nh<br>Kh√¥ng C√≥ Solar/Th√°ng</h3>
                        <div class="value" id="avgCostWithoutSolar">0 ‚Ç´</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for backward compatibility -->
        <input type="hidden" id="solarPrice" value="0">
        <input type="hidden" id="vatRate" value="8">
        
        <!-- Quick Stats Dashboard -->
        <div class="quick-stats" id="quickStats" style="display: none;">
            <h2>
                <span>üìà Ph√¢n T√≠ch Nhanh</span>
                <button class="toggle-btn" onclick="toggleQuickStats()" id="toggleQuickStatsBtn">üîº ·∫®n</button>
            </h2>
            <div class="collapsible-content expanded" id="quickStatsContent">
                <div class="stats-grid">
                <!-- NH√ìM 1: SO S√ÅNH TH√ÅNG -->
                <div class="stat-card">
                    <h4>üèÜ Th√°ng Ti·∫øt Ki·ªám Nhi·ªÅu Nh·∫•t</h4>
                    <div class="stat-value" id="statBestMonth">-</div>
                    <div class="stat-label" id="statBestMonthValue">-</div>
                </div>
                <div class="stat-card">
                    <h4>üìâ Th√°ng Ti·∫øt Ki·ªám √çt Nh·∫•t</h4>
                    <div class="stat-value" id="statWorstMonth">-</div>
                    <div class="stat-label" id="statWorstMonthValue">-</div>
                </div>
                <div class="stat-card">
                    <h4>üå§Ô∏è Th√°ng Solar Nhi·ªÅu Nh·∫•t</h4>
                    <div class="stat-value" id="statBestSolarMonth">-</div>
                    <div class="stat-label" id="statBestSolarValue">-</div>
                </div>
                
                <!-- NH√ìM 2: T·ª∂ L·ªÜ % -->
                <div class="stat-card">
                    <h4>‚ö° T·ª∑ L·ªá S·ª≠ D·ª•ng Solar</h4>
                    <div class="stat-value" id="statSolarPercent">0%</div>
                    <div class="stat-label">Solar so v·ªõi t·ªïng ti√™u th·ª•</div>
                </div>
                <div class="stat-card">
                    <h4>üîå T·ª∑ L·ªá S·ª≠ D·ª•ng L∆∞·ªõi EVN</h4>
                    <div class="stat-value" id="statGridPercent">0%</div>
                    <div class="stat-label">EVN so v·ªõi t·ªïng ti√™u th·ª•</div>
                </div>
                <div class="stat-card">
                    <h4>üîã T·ª∑ L·ªá T·ª± Cung T·ª± C·∫•p</h4>
                    <div class="stat-value" id="statSelfSufficiency">0%</div>
                    <div class="stat-label">T·ª± s·∫£n xu·∫•t / T·ªïng ti√™u th·ª•</div>
                </div>
                <div class="stat-card">
                    <h4>üí° Hi·ªáu Su·∫•t Ti·∫øt Ki·ªám</h4>
                    <div class="stat-value" id="statSavingsPercent">0%</div>
                    <div class="stat-label" id="statSavingsPercentLabel">% gi·∫£m ti·ªÅn ƒëi·ªán nh·ªù Solar</div>
                </div>
                
                <!-- NH√ìM 3: XU H∆Ø·ªöNG & TRUNG B√åNH -->
                <div class="stat-card">
                    <h4>üìä Xu H∆∞·ªõng G·∫ßn ƒê√¢y</h4>
                    <div class="stat-value" id="statTrend">-</div>
                    <div class="stat-label" id="statTrendLabel">-</div>
                </div>
                <div class="stat-card">
                    <h4>üí∞ Trung B√¨nh/Ng√†y</h4>
                    <div class="stat-value" id="statAvgSavings">0 ‚Ç´</div>
                    <div class="stat-label" id="statAvgSavingsLabel">Ti·∫øt ki·ªám TB m·ªói ng√†y</div>
                </div>
                
                <!-- NH√ìM 4: TH√îNG TIN CHUNG -->
                <div class="stat-card">
                    <h4>üìÖ S·ªë Th√°ng C√≥ Data</h4>
                    <div class="stat-value" id="statTotalMonths">0 th√°ng</div>
                    <div class="stat-label">Th√°ng ƒë√£ nh·∫≠p d·ªØ li·ªáu</div>
                </div>
            </div>
            </div>
        </div>

        <div class="roi-section" id="roiSection">
            <h2>
                <span>üí∞ ƒê·∫ßu T∆∞ & ROI</span>
                <button class="toggle-btn" onclick="toggleROI()" id="toggleROIBtn">üîº ·∫®n</button>
            </h2>
            <div class="collapsible-content expanded" id="roiContent">
                <!-- Input Chi Ph√≠ -->
                <div class="roi-input-row">
                    <label>üíµ Chi ph√≠ l·∫Øp ƒë·∫∑t:</label>
                    <input type="text" id="initialCost" value="0" placeholder="VD: 150,000,000">
                    <input type="text" id="initialCostMobile" value="0" placeholder="150,000,000" style="display:none;">
                    <button class="roi-calc-btn" onclick="calculateSavings()">üîÑ T√≠nh</button>
                </div>
                
                <!-- Progress Bar -->
                <div class="roi-progress-section">
                    <div class="roi-progress-header">
                        <span class="roi-progress-title">üìä Ti·∫øn ƒê·ªô Ho√†n V·ªën</span>
                        <span class="roi-progress-percent" id="roiProgressText">0%</span>
                    </div>
                    <div class="roi-progress-bar-wrapper">
                        <div class="roi-progress-bar-bg">
                            <div class="roi-progress-bar-fill" id="roiProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="roi-progress-labels">
                        <span>0 ‚Ç´</span>
                        <span id="roiInitialCost">0 ‚Ç´</span>
                    </div>
                </div>
                
                <!-- ROI Stats Grid -->
                <div class="roi-stats-grid">
                    <div class="roi-stat-item">
                        <div class="roi-stat-icon">üí∞</div>
                        <div class="roi-stat-info">
                            <div class="roi-stat-label">ƒê√£ Ti·∫øt Ki·ªám</div>
                            <div class="roi-stat-value" id="roiSaved">0 ‚Ç´</div>
                            <div class="roi-stat-note" id="roiSavedNote"></div>
                        </div>
                    </div>
                    <div class="roi-stat-item">
                        <div class="roi-stat-icon">üìâ</div>
                        <div class="roi-stat-info">
                            <div class="roi-stat-label">C√≤n Thu H·ªìi</div>
                            <div class="roi-stat-value" id="roiRemaining">0 ‚Ç´</div>
                            <div class="roi-stat-note" id="roiRemainingNote"></div>
                        </div>
                    </div>
                    <div class="roi-stat-item">
                        <div class="roi-stat-icon">‚è±Ô∏è</div>
                        <div class="roi-stat-info">
                            <div class="roi-stat-label">Th·ªùi Gian Ho√†n V·ªën</div>
                            <div class="roi-stat-value" id="roiTime">0 th√°ng</div>
                            <div class="roi-stat-note" id="roiTimeNote"></div>
                        </div>
                    </div>
                    <div class="roi-stat-item profit-item" id="roiProfitCard" style="display: none;">
                        <div class="roi-stat-icon">üéâ</div>
                        <div class="roi-stat-info">
                            <div class="roi-stat-label">Ti·ªÅn L·ªùi</div>
                            <div class="roi-stat-value profit" id="roiProfit">0 ‚Ç´</div>
                            <div class="roi-stat-note" id="roiProfitNote"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden elements for compatibility -->
                <div style="display:none;">
                    <span id="roiMiniCost"></span>
                    <span id="roiMiniSaved"></span>
                    <span id="roiMiniSavedNote"></span>
                    <span id="roiMiniRemaining"></span>
                    <span id="roiMiniRemainingNote"></span>
                    <span id="roiMiniTime"></span>
                    <span id="roiMiniTimeNote"></span>
                    <span id="roiMiniProfit"></span>
                    <span id="roiMiniProfitNote"></span>
                    <span id="roiMiniProfitCard"></span>
                    <span id="roiMiniProgressText"></span>
                    <span id="roiMiniProgressFill"></span>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2>
                <span>üìä Nh·∫≠p D·ªØ Li·ªáu (12 Th√°ng)</span>
                <button class="toggle-btn" onclick="toggleMonthInputs()" id="toggleBtn">üîº ·∫®n</button>
            </h2>
            <div class="collapsible-content expanded" id="monthInputsContainer">
                <div class="month-count-info" id="monthCountInfo">üìÖ Hi·ªán c√≥ 12 th√°ng</div>
                <div class="pagination" id="paginationTop">
                    <button onclick="previousPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="pageInfo">Trang 1</span>
                    <button onclick="nextPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
                <div class="input-grid" id="monthInputs"></div>
                <div class="pagination" id="paginationBottom">
                    <button onclick="previousPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="pageInfoBottom">Trang 1</span>
                    <button onclick="nextPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-calculate" onclick="calculateSavings()">üîç T√≠nh</button>
                <button class="btn-add-month" onclick="addMonth()" title="Th√™m th√°ng m·ªõi (t·ª± ƒë·ªông ƒëi·ªÅn demo data, c√≥ th·ªÉ ch·ªânh s·ª≠a)">‚ûï Th√™m</button>
                <button class="btn-remove-month" onclick="removeMonth()">‚ûñ X√≥a</button>
                <button class="btn-demo" onclick="loadDemoData()" title="T·∫£i demo data cho T·∫§T C·∫¢ th√°ng hi·ªán t·∫°i (t·ª± ƒë·ªông tƒÉng 3%/nƒÉm)">üéØ Demo</button>
                <button class="btn-save" onclick="saveSettings()">üíæ L∆∞u</button>
                <button class="btn-load" onclick="loadSettings()">üìÇ T·∫£i</button>
                <button class="btn-export" onclick="exportSettings()">üì§ Xu·∫•t</button>
                <button class="btn-export-csv" onclick="exportToCSV()" title="Xu·∫•t b√°o c√°o chi ti·∫øt d·∫°ng CSV (Excel)">üìä CSV</button>
                <button class="btn-import" onclick="document.getElementById('importFile').click()">üì• Nh·∫≠p</button>
                <input type="file" id="importFile" accept=".json" onchange="importSettings(event)" style="display: none;">
                <button class="btn-reset" onclick="resetData()">üîÑ Reset</button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="savingsChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="solarChart"></canvas>
        </div>

        <div class="month-details">
            <h2>
                <span>üìã Chi Ti·∫øt T·ª´ng Th√°ng</span>
                <button class="toggle-btn" onclick="toggleMonthDetails()" id="toggleDetailsBtn">üîº ·∫®n</button>
            </h2>
            <div class="details-grid expanded" id="monthDetailsContainer">
                <div class="month-count-info" id="detailsMonthCountInfo">üìÖ Hi·ªán c√≥ 12 th√°ng</div>
                <div class="pagination" id="detailsPaginationTop">
                    <button onclick="previousDetailsPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="detailsPageInfo">Trang 1</span>
                    <button onclick="nextDetailsPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
                <div id="monthDetails">
                    <!-- Chi ti·∫øt s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
                </div>
                <div class="pagination" id="detailsPaginationBottom">
                    <button onclick="previousDetailsPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="detailsPageInfoBottom">Trang 1</span>
                    <button onclick="nextDetailsPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let autoSaveTimeout = null;
        let totalMonths = 12; // S·ªë th√°ng hi·ªán t·∫°i, c√≥ th·ªÉ thay ƒë·ªïi
        let startYear = new Date().getFullYear(); // NƒÉm b·∫Øt ƒë·∫ßu
        let startMonth = 1; // Th√°ng b·∫Øt ƒë·∫ßu (1-12)
        
        // Pagination for input
        let currentPage = 1;
        const MONTHS_PER_PAGE = 12; // Hi·ªÉn th·ªã 12 th√°ng m·ªói trang
        
        // Pagination for details
        let currentDetailsPage = 1;
        const DETAILS_MONTHS_PER_PAGE = 24; // Hi·ªÉn th·ªã 24 th√°ng m·ªói trang (2 nƒÉm)
        let allMonthlyDetails = []; // L∆∞u t·∫•t c·∫£ chi ti·∫øt th√°ng

        // T·∫°o t√™n th√°ng ƒë·ªông
        function getMonthName(index) {
            // T√≠nh th√°ng th·ª±c t·∫ø d·ª±a tr√™n startMonth
            const totalMonthsFromStart = startMonth - 1 + index;
            const monthInYear = (totalMonthsFromStart % 12) + 1;
            const yearOffset = Math.floor(totalMonthsFromStart / 12);
            const year = startYear + yearOffset;
            return `Th√°ng ${monthInYear}/${year}`;
        }

        // L·∫•y danh s√°ch t√™n th√°ng cho bi·ªÉu ƒë·ªì
        function getMonthNames() {
            const names = [];
            for (let i = 0; i < totalMonths; i++) {
                names.push(getMonthName(i));
            }
            return names;
        }

        // Format s·ªë ti·ªÅn v·ªõi d·∫•u ph·∫©y
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // X√≥a d·∫•u ph·∫©y kh·ªèi s·ªë
        function unformatNumber(str) {
            return str.replace(/,/g, '');
        }

        // X·ª≠ l√Ω input chi ph√≠ l·∫Øp ƒë·∫∑t (c·∫£ desktop v√† mobile)
        function setupInitialCostInput() {
            const desktopInput = document.getElementById('initialCost');
            const mobileInput = document.getElementById('initialCostMobile');
            
            // H√†m x·ª≠ l√Ω format chung
            function handleInput(e, syncTarget) {
                let value = unformatNumber(e.target.value);
                value = value.replace(/[^0-9]/g, '');
                
                if (value) {
                    e.target.value = formatNumber(value);
                    if (syncTarget) syncTarget.value = formatNumber(value);
                } else {
                    e.target.value = '';
                    if (syncTarget) syncTarget.value = '';
                }
            }
            
            function handleFocus(e) {
                if (e.target.value === '0') {
                    e.target.value = '';
                }
            }
            
            function handleBlur(e, syncTarget) {
                if (e.target.value === '') {
                    e.target.value = '0';
                    if (syncTarget) syncTarget.value = '0';
                }
            }
            
            // Desktop input events
            desktopInput.addEventListener('input', (e) => handleInput(e, mobileInput));
            desktopInput.addEventListener('focus', handleFocus);
            desktopInput.addEventListener('blur', (e) => handleBlur(e, mobileInput));
            
            // Mobile input events
            if (mobileInput) {
                mobileInput.addEventListener('input', (e) => handleInput(e, desktopInput));
                mobileInput.addEventListener('focus', handleFocus);
                mobileInput.addEventListener('blur', (e) => handleBlur(e, desktopInput));
            }
        }

        // L·∫•y gi√° tr·ªã th·ª±c c·ªßa initialCost (kh√¥ng c√≥ d·∫•u ph·∫©y)
        function getInitialCostValue() {
            const input = document.getElementById('initialCost');
            return parseFloat(unformatNumber(input.value)) || 0;
        }

        // Set gi√° tr·ªã cho initialCost (t·ª± ƒë·ªông format) - c·∫£ desktop v√† mobile
        function setInitialCostValue(value) {
            const desktopInput = document.getElementById('initialCost');
            const mobileInput = document.getElementById('initialCostMobile');
            const formattedValue = value > 0 ? formatNumber(value.toString()) : '0';
            
            desktopInput.value = formattedValue;
            if (mobileInput) mobileInput.value = formattedValue;
        }

        // D·ªØ li·ªáu demo
        const demoData = {
            gridPrice: 2500,
            solarPrice: 0,
            vatRate: 8,
            initialCost: 150000000, // 150 tri·ªáu VNƒê
            monthlyData: [
                { load: 820.5, grid: 230, backup: 0.5, gridPrice: 2500 },      // Th√°ng 1
                { load: 795.8, grid: 220, backup: 0.4, gridPrice: 2500 },      // Th√°ng 2
                { load: 840.3, grid: 245, backup: 0.6, gridPrice: 2600 },      // Th√°ng 3 (gi√° tƒÉng)
                { load: 880.6, grid: 260, backup: 0.7, gridPrice: 2600 },      // Th√°ng 4
                { load: 920.4, grid: 275, backup: 0.8, gridPrice: 2700 },      // Th√°ng 5 (gi√° tƒÉng)
                { load: 910.2, grid: 270, backup: 0.7, gridPrice: 2700 },      // Th√°ng 6
                { load: 850.7, grid: 250, backup: 0.6, gridPrice: 2700 },      // Th√°ng 7
                { load: 815.3, grid: 235, backup: 0.5, gridPrice: 2600 },      // Th√°ng 8
                { load: 827.4, grid: 279.0, backup: 0.4, gridPrice: 2600 },    // Th√°ng 9
                { load: 710.0, grid: 225.0, backup: 0.3, gridPrice: 2500 },    // Th√°ng 10
                { load: 765.5, grid: 240.0, backup: 0.4, gridPrice: 2500 },    // Th√°ng 11
                { load: 795.0, grid: 255.0, backup: 0.5, gridPrice: 2500 }     // Th√°ng 12
            ]
        };

        // Kh·ªüi t·∫°o form nh·∫≠p li·ªáu - ƒê·ªông v·ªõi Ph√¢n trang
        function initializeInputs(keepCurrentData = false) {
            const container = document.getElementById('monthInputs');
            
            // L∆∞u d·ªØ li·ªáu hi·ªán t·∫°i tr∆∞·ªõc khi clear
            let savedData = {};
            if (keepCurrentData) {
                for (let i = 0; i < totalMonths; i++) {
                    const loadEl = document.getElementById(`load${i}`);
                    const gridEl = document.getElementById(`grid${i}`);
                    const backupEl = document.getElementById(`backup${i}`);
                    if (loadEl) savedData[i] = {
                        load: loadEl.value,
                        grid: gridEl.value,
                        backup: backupEl.value
                    };
                }
            }
            
            container.innerHTML = '';
            
            // T√≠nh to√°n trang
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const startIndex = (currentPage - 1) * MONTHS_PER_PAGE;
            const endIndex = Math.min(startIndex + MONTHS_PER_PAGE, totalMonths);
            
            // Ch·ªâ hi·ªÉn th·ªã th√°ng trong trang hi·ªán t·∫°i
            for (let i = startIndex; i < endIndex; i++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-input';
                
                // L·∫•y gi√° tr·ªã theo th·ª© t·ª± ∆∞u ti√™n: savedData > monthDataCache > default
                let loadVal = '0', gridVal = '0', backupVal = '0';
                
                if (savedData[i]) {
                    loadVal = savedData[i].load;
                    gridVal = savedData[i].grid;
                    backupVal = savedData[i].backup;
                } else if (monthDataCache[`load${i}`] !== undefined) {
                    loadVal = monthDataCache[`load${i}`];
                    gridVal = monthDataCache[`grid${i}`] || '0';
                    backupVal = monthDataCache[`backup${i}`] || '0';
                }
                
                monthDiv.innerHTML = `
                    <div class="month-header">
                        <h4>${getMonthName(i)}</h4>
                        <button class="month-delete-btn" onclick="deleteSpecificMonth(${i})" title="X√≥a th√°ng n√†y">‚àí</button>
                    </div>
                    <label>üîå Load (kWh)</label>
                    <input type="number" id="load${i}" value="${loadVal}" min="0" step="0.1" placeholder="0">
                    
                    <label>‚ö° Grid EVN (kWh)</label>
                    <input type="number" id="grid${i}" value="${gridVal}" min="0" step="0.1" placeholder="0">
                    
                    <label>üîã Backup (kWh)</label>
                    <input type="number" id="backup${i}" value="${backupVal}" min="0" step="0.1" placeholder="0">
                `;
                container.appendChild(monthDiv);
            }
            
            updateMonthCountInfo();
            updatePagination();
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin ph√¢n trang
        function updatePagination() {
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            const startMonth = (currentPage - 1) * MONTHS_PER_PAGE + 1;
            const endMonth = Math.min(currentPage * MONTHS_PER_PAGE, totalMonths);
            
            const pageText = `Trang ${currentPage}/${totalPages} (Th√°ng ${startMonth}-${endMonth}/${totalMonths})`;
            document.getElementById('pageInfo').textContent = pageText;
            document.getElementById('pageInfoBottom').textContent = pageText;
            
            // Update button states
            const prevButtons = document.querySelectorAll('.pagination button:first-child');
            const nextButtons = document.querySelectorAll('.pagination button:last-child');
            
            prevButtons.forEach(btn => btn.disabled = currentPage <= 1);
            nextButtons.forEach(btn => btn.disabled = currentPage >= totalPages);
            
            // ·∫®n pagination n·∫øu ch·ªâ c√≥ 1 trang
            const paginationEls = document.querySelectorAll('.pagination');
            paginationEls.forEach(el => {
                el.style.display = totalPages <= 1 ? 'none' : 'flex';
            });
        }
        
        // Trang tr∆∞·ªõc
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                initializeInputs(true);
                // Scroll to top
                document.getElementById('monthInputsContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Trang sau
        function nextPage() {
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                initializeInputs(true);
                // Scroll to top
                document.getElementById('monthInputsContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // C·∫≠p nh·∫≠t th√¥ng tin s·ªë th√°ng
        function updateMonthCountInfo() {
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;
            let info = `üìÖ Hi·ªán c√≥ ${totalMonths} th√°ng`;
            if (years > 0) {
                info += ` (${years} nƒÉm ${months} th√°ng)`;
            }
            document.getElementById('monthCountInfo').textContent = info;
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            document.querySelector('.input-section h2 span').textContent = `üìä Nh·∫≠p D·ªØ Li·ªáu (${totalMonths} Th√°ng)`;
        }

        // Th√™m th√°ng m·ªõi
        function addMonth() {
            totalMonths++;
            
            // T·ª± ƒë·ªông fill demo data cho th√°ng m·ªõi (option)
            const newMonthIndex = totalMonths - 1;
            const monthInYear = newMonthIndex % 12;
            const yearIndex = Math.floor(newMonthIndex / 12);
            const variation = 1 + (yearIndex * 0.03); // TƒÉng 3% m·ªói nƒÉm
            
            // L·∫•y base data t·ª´ pattern
            if (demoData.monthlyData[monthInYear]) {
                const baseData = demoData.monthlyData[monthInYear];
                monthDataCache[`load${newMonthIndex}`] = (baseData.load * variation).toFixed(1);
                monthDataCache[`grid${newMonthIndex}`] = (baseData.grid * variation).toFixed(1);
                monthDataCache[`backup${newMonthIndex}`] = (baseData.backup * variation).toFixed(1);
                monthDataCache[`gridPrice${newMonthIndex}`] = (baseData.gridPrice + (yearIndex * 100)).toString();
            }
            
            // T·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn trang cu·ªëi n·∫øu th√™m th√°ng m·ªõi
            currentPage = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            initializeInputs(true);
            showNotification(`‚ûï ƒê√£ th√™m ${getMonthName(newMonthIndex)}! ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn d·ªØ li·ªáu demo (c√≥ th·ªÉ ch·ªânh s·ª≠a)`, 'success');
        }

        // X√≥a th√°ng cu·ªëi
        function removeMonth() {
            if (totalMonths <= 1) {
                showNotification('‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a! Ph·∫£i c√≥ √≠t nh·∫•t 1 th√°ng.', 'error');
                return;
            }
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${getMonthName(totalMonths - 1)}?`)) {
                totalMonths--;
                // ƒêi·ªÅu ch·ªânh trang n·∫øu c·∫ßn
                const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
                if (currentPage > totalPages) currentPage = totalPages;
                initializeInputs(true);
                showNotification(`‚ùå ƒê√£ x√≥a th√°ng cu·ªëi!`, 'info');
            }
        }

        // X√≥a m·ªôt th√°ng c·ª• th·ªÉ (b·∫•t k·ª≥ v·ªã tr√≠ n√†o)
        function deleteSpecificMonth(indexToDelete) {
            if (totalMonths <= 1) {
                showNotification('‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a! Ph·∫£i c√≥ √≠t nh·∫•t 1 th√°ng.', 'error');
                return;
            }
            
            const monthName = getMonthName(indexToDelete);
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${monthName}?`)) {
                // L∆∞u t·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i v√†o cache tr∆∞·ªõc
                for (let i = 0; i < totalMonths; i++) {
                    const loadEl = document.getElementById(`load${i}`);
                    const gridEl = document.getElementById(`grid${i}`);
                    const backupEl = document.getElementById(`backup${i}`);
                    
                    if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                    if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                    if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
                }
                
                // T·∫°o cache m·ªõi, b·ªè qua th√°ng b·ªã x√≥a v√† d·ªãch chuy·ªÉn c√°c th√°ng sau l√™n
                const newCache = {};
                let newIndex = 0;
                
                for (let i = 0; i < totalMonths; i++) {
                    if (i !== indexToDelete) {
                        newCache[`load${newIndex}`] = monthDataCache[`load${i}`] || '0';
                        newCache[`grid${newIndex}`] = monthDataCache[`grid${i}`] || '0';
                        newCache[`backup${newIndex}`] = monthDataCache[`backup${i}`] || '0';
                        newIndex++;
                    }
                }
                
                // C·∫≠p nh·∫≠t cache v√† gi·∫£m t·ªïng s·ªë th√°ng
                monthDataCache = newCache;
                totalMonths--;
                
                // N·∫øu x√≥a th√°ng ƒë·∫ßu ti√™n, c·∫ßn c·∫≠p nh·∫≠t startMonth
                if (indexToDelete === 0) {
                    // Th√°ng ti·∫øp theo tr·ªü th√†nh th√°ng ƒë·∫ßu
                    startMonth++;
                    if (startMonth > 12) {
                        startMonth = 1;
                        startYear++;
                    }
                }
                
                // ƒêi·ªÅu ch·ªânh trang n·∫øu c·∫ßn
                const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
                if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
                
                // Kh·ªüi t·∫°o l·∫°i inputs
                initializeInputs();
                
                showNotification(`‚ùå ƒê√£ x√≥a ${monthName}!`, 'info');
                
                // T√≠nh to√°n l·∫°i
                calculateSavings();
                saveSettings(true);
            }
        }

        // Toggle hi·ªÉn th·ªã/·∫©n ph·∫ßn nh·∫≠p d·ªØ li·ªáu
        function toggleMonthInputs() {
            const container = document.getElementById('monthInputsContainer');
            const btn = document.getElementById('toggleBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // Toggle hi·ªÉn th·ªã/·∫©n ph·∫ßn chi ti·∫øt th√°ng
        function toggleMonthDetails() {
            const container = document.getElementById('monthDetails');
            const btn = document.getElementById('toggleDetailsBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // Toggle ROI Section
        function toggleROI() {
            const container = document.getElementById('roiContent');
            const btn = document.getElementById('toggleROIBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // Toggle Quick Stats
        function toggleQuickStats() {
            const container = document.getElementById('quickStatsContent');
            const btn = document.getElementById('toggleQuickStatsBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // B·ªè h√†m scheduleAutoSave - kh√¥ng c√≤n c·∫ßn t·ª± ƒë·ªông l∆∞u khi thay ƒë·ªïi

        // T·∫°o d·ªØ li·ªáu demo t·ª± ƒë·ªông cho t·∫•t c·∫£ th√°ng
        function generateDemoDataForAllMonths() {
            const generatedData = [];
            
            // Base data pattern (12 th√°ng)
            const basePattern = demoData.monthlyData;
            
            // T·∫°o data cho t·∫•t c·∫£ th√°ng
            for (let i = 0; i < totalMonths; i++) {
                // L·∫∑p l·∫°i pattern 12 th√°ng
                const monthInYear = i % 12;
                const baseData = basePattern[monthInYear];
                
                // Th√™m variation nh·ªè ƒë·ªÉ data kh√¥ng gi·ªëng h·ªát nhau m·ªói nƒÉm
                const yearIndex = Math.floor(i / 12);
                const variation = 1 + (yearIndex * 0.03); // TƒÉng 3% m·ªói nƒÉm
                
                generatedData.push({
                    load: parseFloat((baseData.load * variation).toFixed(1)),
                    grid: parseFloat((baseData.grid * variation).toFixed(1)),
                    backup: parseFloat((baseData.backup * variation).toFixed(1))
                });
            }
            
            return generatedData;
        }
        
        // T·∫£i d·ªØ li·ªáu demo
        function loadDemoData() {
            // Set hidden values for backward compatibility
            document.getElementById('solarPrice').value = demoData.solarPrice;
            document.getElementById('vatRate').value = demoData.vatRate;
            
            // Set initial cost
            setInitialCostValue(demoData.initialCost);
            
            // Clear cache
            monthDataCache = {};

            // T·∫°o demo data cho t·∫•t c·∫£ th√°ng
            const allMonthsData = generateDemoDataForAllMonths();
            
            // Load data v√†o cache
            allMonthsData.forEach((data, index) => {
                monthDataCache[`load${index}`] = data.load.toString();
                monthDataCache[`grid${index}`] = data.grid.toString();
                monthDataCache[`backup${index}`] = data.backup.toString();
            });
            
            // Load v√†o inputs hi·ªÉn th·ªã (ch·ªâ trang hi·ªán t·∫°i)
            allMonthsData.forEach((data, index) => {
                const loadEl = document.getElementById(`load${index}`);
                const gridEl = document.getElementById(`grid${index}`);
                const backupEl = document.getElementById(`backup${index}`);
                
                if (loadEl) loadEl.value = data.load;
                if (gridEl) gridEl.value = data.grid;
                if (backupEl) backupEl.value = data.backup;
            });

            showNotification(`‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu demo cho T·∫§T C·∫¢ ${totalMonths} th√°ng (t·ª± ƒë·ªông tƒÉng 3%/nƒÉm)!`, 'success');
            calculateSavings();
        }

        // Helper: L·∫•y gi√° tr·ªã t·ª´ input, n·∫øu kh√¥ng t·ªìn t·∫°i th√¨ l·∫•y t·ª´ cache
        let monthDataCache = {}; // Cache ƒë·ªÉ l∆∞u d·ªØ li·ªáu c√°c th√°ng kh√¥ng hi·ªÉn th·ªã
        
        function getMonthValue(id, defaultValue = '0') {
            const el = document.getElementById(id);
            if (el) {
                // Update cache
                monthDataCache[id] = el.value;
                return el.value;
            }
            // Return from cache if exists
            return monthDataCache[id] || defaultValue;
        }
        
        // L∆∞u c√†i ƒë·∫∑t v√†o localStorage - Real-time
        function saveSettings(isAutoSave = false) {
            // C·∫≠p nh·∫≠t cache v·ªõi gi√° tr·ªã hi·ªán t·∫°i
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            const settings = {
                solarPrice: document.getElementById('solarPrice').value,
                vatRate: document.getElementById('vatRate').value,
                initialCost: getInitialCostValue().toString(),
                totalMonths: totalMonths,
                startYear: startYear,
                startMonth: startMonth,
                currentPage: currentPage,
                monthlyData: [],
                savedAt: new Date().toISOString(),
                version: '3.3'
            };

            for (let i = 0; i < totalMonths; i++) {
                settings.monthlyData.push({
                    load: getMonthValue(`load${i}`, '0'),
                    grid: getMonthValue(`grid${i}`, '0'),
                    backup: getMonthValue(`backup${i}`, '0')
                });
            }

            try {
                localStorage.setItem('solarSettings', JSON.stringify(settings));
                updateStorageStatus();
                
                // Hi·ªÉn th·ªã indicator khi l∆∞u
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.classList.add('active');
                indicator.textContent = 'üíæ ƒêang l∆∞u...';
                
                setTimeout(() => {
                    indicator.classList.remove('active');
                    indicator.textContent = 'üíæ ƒê√£ l∆∞u!';
                    setTimeout(() => {
                        indicator.textContent = 'üíæ L∆∞u t·ª± ƒë·ªông khi b·∫•m L∆∞u C√†i ƒê·∫∑t';
                    }, 2000);
                }, 500);
                
                if (!isAutoSave) {
                    showNotification('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                }
            } catch (e) {
                showNotification('‚ùå L·ªói khi l∆∞u c√†i ƒë·∫∑t: ' + e.message, 'error');
            }
        }

        // Xu·∫•t c√†i ƒë·∫∑t ra file JSON
        function exportSettings() {
            // C·∫≠p nh·∫≠t cache tr∆∞·ªõc khi export
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            const settings = {
                solarPrice: document.getElementById('solarPrice').value,
                vatRate: document.getElementById('vatRate').value,
                initialCost: getInitialCostValue().toString(),
                totalMonths: totalMonths,
                startYear: startYear,
                monthlyData: [],
                exportedAt: new Date().toISOString(),
                version: '3.2'
            };

            for (let i = 0; i < totalMonths; i++) {
                settings.monthlyData.push({
                    month: getMonthName(i),
                    load: getMonthValue(`load${i}`, '0'),
                    grid: getMonthValue(`grid${i}`, '0'),
                    backup: getMonthValue(`backup${i}`, '0')
                });
            }

            try {
                const dataStr = JSON.stringify(settings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `solar-settings-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('üì§ ƒê√£ xu·∫•t file c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
            } catch (e) {
                showNotification('‚ùå L·ªói khi xu·∫•t file: ' + e.message, 'error');
            }
        }
        
        // ==================== EXPORT TO CSV ====================
        function exportToCSV() {
            // C·∫≠p nh·∫≠t cache tr∆∞·ªõc khi export
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            // T√≠nh to√°n tr∆∞·ªõc ƒë·ªÉ c√≥ d·ªØ li·ªáu
            calculateSavings();
            
            // T·∫°o CSV content
            let csvContent = "B√°o C√°o Chi Ti·∫øt NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi\n";
            csvContent += `Xu·∫•t ng√†y: ${new Date().toLocaleDateString('vi-VN')}\n\n`;
            
            // Header
            csvContent += "Th√°ng,ƒêi·ªán Load (kWh),ƒêi·ªán Grid EVN (kWh),Backup (kWh),Solar S·∫£n Xu·∫•t (kWh),Chi Ph√≠ Grid (VNƒê),Chi Ph√≠ Solar (VNƒê),Chi Ph√≠ Th·ª±c T·∫ø (VNƒê),Chi Ph√≠ Kh√¥ng Solar (VNƒê),Ti·∫øt Ki·ªám (VNƒê)\n";
            
            let totalSavings = 0;
            let totalLoad = 0;
            let totalSolar = 0;
            let totalGrid = 0;
            let totalCostWithoutSolar = 0;
            
            const vatRate = 0.08;
            
            // Data rows
            for (let i = 0; i < totalMonths; i++) {
                const load = parseFloat(getMonthValue(`load${i}`, '0')) || 0;
                const grid = parseFloat(getMonthValue(`grid${i}`, '0')) || 0;
                const backup = parseFloat(getMonthValue(`backup${i}`, '0')) || 0;
                
                const solarProduced = load + backup - grid;
                const gridCost = calculateTieredPrice(grid, vatRate);
                const costWithoutSolar = calculateTieredPrice(solarProduced, vatRate);
                const solarCost = 0;
                const actualCost = gridCost + solarCost;
                const savings = costWithoutSolar - solarCost;
                
                totalSavings += savings;
                totalLoad += load;
                totalSolar += solarProduced;
                totalGrid += grid;
                totalCostWithoutSolar += costWithoutSolar;
                
                csvContent += `${getMonthName(i)},${load},${grid},${backup},${solarProduced.toFixed(2)},${gridCost.toFixed(0)},${solarCost},${actualCost.toFixed(0)},${costWithoutSolar.toFixed(0)},${savings.toFixed(0)}\n`;
            }
            
            // Summary rows
            csvContent += `\nT·ªïng C·ªông,${totalLoad.toFixed(2)},${totalGrid.toFixed(2)},-,${totalSolar.toFixed(2)},-,-,-,${totalCostWithoutSolar.toFixed(0)},${totalSavings.toFixed(0)}\n`;
            
            const monthsWithData = totalMonths;
            const avgSavings = monthsWithData > 0 ? totalSavings / monthsWithData : 0;
            const avgLoad = monthsWithData > 0 ? totalLoad / monthsWithData : 0;
            const avgSolar = monthsWithData > 0 ? totalSolar / monthsWithData : 0;
            const avgGrid = monthsWithData > 0 ? totalGrid / monthsWithData : 0;
            
            csvContent += `Trung B√¨nh,${avgLoad.toFixed(2)},${avgGrid.toFixed(2)},-,${avgSolar.toFixed(2)},-,-,-,-,${avgSavings.toFixed(0)}\n`;
            
            // ROI info
            const initialCost = getInitialCostValue();
            if (initialCost > 0) {
                const paybackMonths = avgSavings > 0 ? initialCost / avgSavings : 0;
                const paybackYears = (paybackMonths / 12).toFixed(1);
                const percentRecovered = (totalSavings / initialCost * 100).toFixed(1);
                
                csvContent += `\nPh√¢n T√≠ch ROI\n`;
                csvContent += `Chi Ph√≠ L·∫Øp ƒê·∫∑t (VNƒê),${initialCost}\n`;
                csvContent += `ƒê√£ Ti·∫øt Ki·ªám (VNƒê),${totalSavings.toFixed(0)}\n`;
                csvContent += `Th·ªùi Gian Ho√†n V·ªën (nƒÉm),${paybackYears}\n`;
                csvContent += `Th·ªùi Gian Ho√†n V·ªën (th√°ng),${Math.round(paybackMonths)}\n`;
                csvContent += `% Ho√†n V·ªën,${percentRecovered}%\n`;
            }
            
            // Quick Stats
            csvContent += `\nTh·ªëng K√™ Nhanh\n`;
            const solarPercent = totalLoad > 0 ? ((totalSolar / totalLoad) * 100).toFixed(1) : 0;
            const gridPercent = totalLoad > 0 ? ((totalGrid / totalLoad) * 100).toFixed(1) : 0;
            const savingsPercent = totalCostWithoutSolar > 0 ? ((totalSavings / totalCostWithoutSolar) * 100).toFixed(1) : 0;
            
            csvContent += `T·ª∑ L·ªá Solar (%),${solarPercent}\n`;
            csvContent += `T·ª∑ L·ªá Grid EVN (%),${gridPercent}\n`;
            csvContent += `Hi·ªáu Su·∫•t Ti·∫øt Ki·ªám (%),${savingsPercent}\n`;
            
            // Download CSV
            try {
                const BOM = '\uFEFF'; // UTF-8 BOM for Excel compatibility
                const dataBlob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `solar-report-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('üìä ƒê√£ xu·∫•t b√°o c√°o CSV th√†nh c√¥ng!', 'success');
            } catch (e) {
                showNotification('‚ùå L·ªói khi xu·∫•t CSV: ' + e.message, 'error');
            }
        }
        // ==================== END EXPORT TO CSV ====================
        
        // T·∫£i c√†i ƒë·∫∑t t·ª´ localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('solarSettings');
            
            if (!savedSettings) {
                showNotification('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë√£ l∆∞u!', 'info');
                return;
            }

            try {
                const settings = JSON.parse(savedSettings);
                
                // C·∫≠p nh·∫≠t s·ªë th√°ng, nƒÉm v√† th√°ng b·∫Øt ƒë·∫ßu n·∫øu c√≥
                if (settings.totalMonths) {
                    totalMonths = settings.totalMonths;
                }
                if (settings.startYear) {
                    startYear = settings.startYear;
                }
                if (settings.startMonth) {
                    startMonth = settings.startMonth;
                } else {
                    startMonth = 1; // Default to January if not saved
                }
                if (settings.currentPage) {
                    currentPage = settings.currentPage;
                }
                
                // Clear cache v√† load l·∫°i
                monthDataCache = {};
                
                // Load data v√†o cache tr∆∞·ªõc
                settings.monthlyData.forEach((data, index) => {
                    monthDataCache[`load${index}`] = data.load;
                    monthDataCache[`grid${index}`] = data.grid;
                    monthDataCache[`backup${index}`] = data.backup;
                });
                
                // Kh·ªüi t·∫°o l·∫°i inputs v·ªõi s·ªë th√°ng m·ªõi
                initializeInputs();
                
                document.getElementById('solarPrice').value = settings.solarPrice || 0;
                document.getElementById('vatRate').value = settings.vatRate;
                setInitialCostValue(parseFloat(settings.initialCost) || 0);

                // Load data v√†o c√°c input hi·ªÉn th·ªã
                settings.monthlyData.forEach((data, index) => {
                    if (index < totalMonths) {
                        const loadEl = document.getElementById(`load${index}`);
                        const gridEl = document.getElementById(`grid${index}`);
                        const backupEl = document.getElementById(`backup${index}`);
                        
                        if (loadEl) loadEl.value = data.load;
                        if (gridEl) gridEl.value = data.grid;
                        if (backupEl) backupEl.value = data.backup;
                    }
                });

                showNotification('üìÇ ƒê√£ t·∫£i c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                calculateSavings();
            } catch (e) {
                showNotification('‚ùå L·ªói khi t·∫£i c√†i ƒë·∫∑t: ' + e.message, 'error');
            }
        }

        // Nh·∫≠p c√†i ƒë·∫∑t t·ª´ file JSON
        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // C·∫≠p nh·∫≠t s·ªë th√°ng v√† nƒÉm - QUAN TR·ªåNG!
                    if (settings.totalMonths) {
                        totalMonths = settings.totalMonths;
                    } else if (settings.monthlyData) {
                        // Fallback: N·∫øu kh√¥ng c√≥ totalMonths, d√πng length c·ªßa monthlyData
                        totalMonths = settings.monthlyData.length;
                    }
                    
                    if (settings.startYear) {
                        startYear = settings.startYear;
                    } else {
                        startYear = new Date().getFullYear();
                    }
                    
                    // Reset v·ªÅ trang 1
                    currentPage = 1;
                    
                    // Clear cache v√† load l·∫°i
                    monthDataCache = {};
                    
                    // Load data v√†o cache tr∆∞·ªõc
                    settings.monthlyData.forEach((data, index) => {
                        monthDataCache[`load${index}`] = data.load;
                        monthDataCache[`grid${index}`] = data.grid;
                        monthDataCache[`backup${index}`] = data.backup;
                    });
                    
                    // Kh·ªüi t·∫°o l·∫°i inputs v·ªõi s·ªë th√°ng m·ªõi
                    initializeInputs();
                    
                    document.getElementById('solarPrice').value = settings.solarPrice || 0;
                    document.getElementById('vatRate').value = settings.vatRate || 8;
                    setInitialCostValue(parseFloat(settings.initialCost) || 0);

                    // Load data v√†o c√°c input hi·ªÉn th·ªã
                    settings.monthlyData.forEach((data, index) => {
                        if (index < totalMonths) {
                            const loadEl = document.getElementById(`load${index}`);
                            const gridEl = document.getElementById(`grid${index}`);
                            const backupEl = document.getElementById(`backup${index}`);
                            
                            if (loadEl) loadEl.value = data.load;
                            if (gridEl) gridEl.value = data.grid;
                            if (backupEl) backupEl.value = data.backup;
                        }
                    });

                    showNotification('üì• ƒê√£ nh·∫≠p file c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                    calculateSavings();
                    saveSettings(true);
                } catch (e) {
                    showNotification('‚ùå L·ªói khi ƒë·ªçc file: ' + e.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞u tr·ªØ
        function updateStorageStatus() {
            const savedSettings = localStorage.getItem('solarSettings');
            const statusEl = document.getElementById('storageStatus');
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    const savedDate = new Date(settings.savedAt);
                    const formattedDate = savedDate.toLocaleString('vi-VN');
                    statusEl.textContent = `ƒê√£ l∆∞u l·∫ßn cu·ªëi: ${formattedDate}`;
                } catch (e) {
                    statusEl.textContent = 'C√≥ d·ªØ li·ªáu ƒë√£ l∆∞u';
                }
            } else {
                statusEl.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu l∆∞u tr·ªØ';
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // T√≠nh gi√° ƒëi·ªán theo b·∫≠c thang EVN m·ªõi (bao g·ªìm VAT 8%)
        function calculateTieredPrice(kWh, vatRate) {
            if (kWh <= 0) return 0;
            
            let totalCost = 0;
            let remaining = kWh;
            
            // B·∫≠c 1: 0 - 50 kWh = 1,984 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier1 = Math.min(remaining, 50);
                totalCost += tier1 * 1984;
                remaining -= tier1;
            }
            
            // B·∫≠c 2: 51 - 100 kWh = 2,050 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier2 = Math.min(remaining, 50); // 50 kWh trong b·∫≠c n√†y
                totalCost += tier2 * 2050;
                remaining -= tier2;
            }
            
            // B·∫≠c 3: 101 - 200 kWh = 2,380 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier3 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier3 * 2380;
                remaining -= tier3;
            }
            
            // B·∫≠c 4: 201 - 300 kWh = 2,998 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier4 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier4 * 2998;
                remaining -= tier4;
            }
            
            // B·∫≠c 5: 301 - 400 kWh = 3,350 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier5 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier5 * 3350;
                remaining -= tier5;
            }
            
            // B·∫≠c 6: 401+ kWh = 3,460 ƒë·ªìng/kWh
            if (remaining > 0) {
                totalCost += remaining * 3460;
            }
            
            // √Åp d·ª•ng VAT
            return totalCost * (1 + vatRate);
        }

        // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn VND
        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // ƒê·ªãnh d·∫°ng s·ªë kWh
        function formatKWh(value) {
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value) + ' kWh';
        }

        // T√≠nh to√°n ti·∫øt ki·ªám
        function calculateSavings() {
            const solarPrice = parseFloat(document.getElementById('solarPrice').value);
            const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;

            let totalSavings = 0;
            let totalLoad = 0;
            let totalSolarProduced = 0;
            let totalGrid = 0;
            let totalCostWithoutSolar = 0;
            let monthsWithData = 0; // ƒê·∫øm s·ªë th√°ng c√≥ d·ªØ li·ªáu
            const savingsData = [];
            const solarData = [];
            const monthlyDetails = [];

            // C·∫≠p nh·∫≠t cache tr∆∞·ªõc khi t√≠nh to√°n
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            for (let i = 0; i < totalMonths; i++) {
                const load = parseFloat(getMonthValue(`load${i}`, '0')) || 0;
                const grid = parseFloat(getMonthValue(`grid${i}`, '0')) || 0;
                const backup = parseFloat(getMonthValue(`backup${i}`, '0')) || 0;

                // ƒê·∫øm th√°ng c√≥ d·ªØ li·ªáu (n·∫øu c√≥ √≠t nh·∫•t 1 gi√° tr·ªã > 0)
                if (load > 0 || grid > 0 || backup > 0) {
                    monthsWithData++;
                }

                // T·ªïng ti√™u th·ª• = Load + Backup (ƒë√¢y l√† t·ªïng ƒëi·ªán ti√™u th·ª• th·ª±c t·∫ø)
                const totalConsumption = load + backup;
                
                // ƒêi·ªán m·∫∑t tr·ªùi s·∫£n xu·∫•t = T·ªïng ti√™u th·ª• - Grid EVN
                const solarProduced = totalConsumption - grid;
                
                // Chi ph√≠ l∆∞·ªõi ƒëi·ªán EVN (Grid) - D√ôNG B·∫¨C THANG
                const gridCost = calculateTieredPrice(grid, vatRate);
                
                // Chi ph√≠ n·∫øu KH√îNG C√ì SOLAR = T√≠nh b·∫≠c thang cho TO√ÄN B·ªò ti√™u th·ª• (Load + Backup)
                const costWithoutSolar = calculateTieredPrice(totalConsumption, vatRate);
                
                // Chi ph√≠ ƒëi·ªán m·∫∑t tr·ªùi (hi·ªán t·∫°i = 0 v√¨ t·ª± s·∫£n xu·∫•t)
                const solarCost = solarProduced * solarPrice;
                
                // Chi ph√≠ th·ª±c t·∫ø = Chi ph√≠ l∆∞·ªõi ƒëi·ªán + Chi ph√≠ m·∫∑t tr·ªùi
                const actualCost = gridCost + solarCost;
                
                // Ti·∫øt ki·ªám = Chi ph√≠ n·∫øu kh√¥ng c√≥ Solar - Chi ph√≠ th·ª±c t·∫ø
                const savings = costWithoutSolar - actualCost;

                totalSavings += savings;
                totalLoad += load;
                totalSolarProduced += solarProduced;
                totalGrid += grid;
                totalCostWithoutSolar += costWithoutSolar;
                savingsData.push(savings);
                solarData.push(solarProduced);

                monthlyDetails.push({
                    month: getMonthName(i),
                    load: load,
                    grid: grid,
                    backup: backup,
                    totalConsumption: totalConsumption,
                    solarProduced: solarProduced,
                    gridCost: gridCost,
                    costWithoutSolar: costWithoutSolar,
                    solarCost: solarCost,
                    actualCost: actualCost,
                    savings: savings
                });
            }

            // T√≠nh trung b√¨nh d·ª±a tr√™n s·ªë th√°ng c√≥ d·ªØ li·ªáu
            const avgSavings = monthsWithData > 0 ? totalSavings / monthsWithData : 0;
            const avgLoad = monthsWithData > 0 ? totalLoad / monthsWithData : 0;
            const avgSolar = monthsWithData > 0 ? totalSolarProduced / monthsWithData : 0;
            const avgGrid = monthsWithData > 0 ? totalGrid / monthsWithData : 0;
            const avgCostWithoutSolar = monthsWithData > 0 ? totalCostWithoutSolar / monthsWithData : 0;

            // C·∫≠p nh·∫≠t t·ªïng k·∫øt
            document.getElementById('totalSavings').textContent = formatVND(totalSavings);
            document.getElementById('totalLoad').textContent = formatKWh(totalLoad);
            document.getElementById('totalSolar').textContent = formatKWh(totalSolarProduced);
            document.getElementById('totalGrid').textContent = formatKWh(totalGrid);
            document.getElementById('totalCostWithoutSolar').textContent = formatVND(totalCostWithoutSolar);
            document.getElementById('avgSavings').textContent = formatVND(avgSavings);
            
            // C·∫≠p nh·∫≠t trung b√¨nh m·ªõi
            document.getElementById('avgLoad').textContent = formatKWh(avgLoad);
            document.getElementById('avgSolar').textContent = formatKWh(avgSolar);
            document.getElementById('avgGrid').textContent = formatKWh(avgGrid);
            document.getElementById('avgCostWithoutSolar').textContent = formatVND(avgCostWithoutSolar);

            // T√≠nh to√°n ROI - truy·ªÅn th√™m monthsWithData
            calculateROI(totalSavings, monthsWithData);

            // V·∫Ω bi·ªÉu ƒë·ªì
            drawChart(savingsData);
            drawSolarChart(solarData);

            // Hi·ªÉn th·ªã chi ti·∫øt
            displayDetails(monthlyDetails);
            
            // T√≠nh to√°n Quick Stats
            calculateQuickStats(monthlyDetails, totalSolarProduced, totalLoad, totalGrid, totalSavings, totalCostWithoutSolar, monthsWithData);
        }
        
        // ==================== QUICK STATS CALCULATION ====================
        function calculateQuickStats(monthlyDetails, totalSolar, totalLoad, totalGrid, totalSavings, totalCostWithoutSolar, monthsWithData) {
            // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ d·ªØ li·ªáu
            if (monthlyDetails.length === 0 || totalLoad === 0) {
                document.getElementById('quickStats').style.display = 'none';
                return;
            }
            
            document.getElementById('quickStats').style.display = 'block';
            
            // 1. Th√°ng ti·∫øt ki·ªám nhi·ªÅu nh·∫•t v√† √≠t nh·∫•t
            let bestMonth = monthlyDetails[0];
            let worstMonth = monthlyDetails[0];
            
            monthlyDetails.forEach(month => {
                if (month.savings > bestMonth.savings) bestMonth = month;
                if (month.savings < worstMonth.savings) worstMonth = month;
            });
            
            document.getElementById('statBestMonth').textContent = bestMonth.month;
            document.getElementById('statBestMonthValue').textContent = formatVND(bestMonth.savings);
            document.getElementById('statWorstMonth').textContent = worstMonth.month;
            document.getElementById('statWorstMonthValue').textContent = formatVND(worstMonth.savings);
            
            // 2. T·ª∑ l·ªá s·ª≠ d·ª•ng Solar vs Grid
            const solarPercent = totalLoad > 0 ? ((totalSolar / totalLoad) * 100).toFixed(1) : 0;
            const gridPercent = totalLoad > 0 ? ((totalGrid / totalLoad) * 100).toFixed(1) : 0;
            
            document.getElementById('statSolarPercent').textContent = solarPercent + '%';
            document.getElementById('statGridPercent').textContent = gridPercent + '%';
            
            // 3. Hi·ªáu su·∫•t ti·∫øt ki·ªám = % ti·ªÅn ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c so v·ªõi n·∫øu kh√¥ng c√≥ Solar
            // C√¥ng th·ª©c: (Ti·∫øt ki·ªám / Chi ph√≠ n·∫øu kh√¥ng c√≥ Solar) √ó 100
            // √ù nghƒ©a: B·∫°n ƒë√£ gi·∫£m ƒë∆∞·ª£c bao nhi√™u % ti·ªÅn ƒëi·ªán nh·ªù c√≥ Solar
            let savingsPercent = 0;
            if (totalCostWithoutSolar > 0) {
                // Ti·∫øt ki·ªám = Chi ph√≠ kh√¥ng Solar - Chi ph√≠ th·ª±c t·∫ø (Grid + Solar cost)
                // Hi·ªáu su·∫•t = Ti·∫øt ki·ªám / Chi ph√≠ kh√¥ng Solar √ó 100
                savingsPercent = ((totalSavings / totalCostWithoutSolar) * 100);
                savingsPercent = Math.min(savingsPercent, 100).toFixed(1); // Kh√¥ng v∆∞·ª£t qu√° 100%
            }
            document.getElementById('statSavingsPercent').textContent = savingsPercent + '%';
            document.getElementById('statSavingsPercentLabel').textContent = `Gi·∫£m ${savingsPercent}% ti·ªÅn ƒëi·ªán`;
            
            // 4. Xu h∆∞·ªõng th√°ng g·∫ßn ƒë√¢y (so s√°nh 3 th√°ng g·∫ßn nh·∫•t v·ªõi 3 th√°ng tr∆∞·ªõc ƒë√≥)
            if (monthlyDetails.length >= 6) {
                const recent3 = monthlyDetails.slice(-3);
                const previous3 = monthlyDetails.slice(-6, -3);
                
                const recentAvg = recent3.reduce((sum, m) => sum + m.savings, 0) / 3;
                const previousAvg = previous3.reduce((sum, m) => sum + m.savings, 0) / 3;
                
                let trendPercent = 0;
                if (previousAvg > 0) {
                    trendPercent = (((recentAvg - previousAvg) / previousAvg) * 100);
                    trendPercent = parseFloat(trendPercent.toFixed(1));
                }
                
                if (trendPercent > 5) {
                    document.getElementById('statTrend').innerHTML = 'üìà TƒÉng';
                    document.getElementById('statTrendLabel').textContent = `+${trendPercent}% so v·ªõi 3 th√°ng tr∆∞·ªõc`;
                    document.getElementById('statTrend').className = 'stat-value';
                    document.getElementById('statTrend').style.color = '#6ee7b7';
                } else if (trendPercent < -5) {
                    document.getElementById('statTrend').innerHTML = 'üìâ Gi·∫£m';
                    document.getElementById('statTrendLabel').textContent = `${trendPercent}% so v·ªõi 3 th√°ng tr∆∞·ªõc`;
                    document.getElementById('statTrend').className = 'stat-value';
                    document.getElementById('statTrend').style.color = '#fca5a5';
                } else {
                    document.getElementById('statTrend').innerHTML = '‚û°Ô∏è ·ªîn ƒë·ªãnh';
                    document.getElementById('statTrendLabel').textContent = `Thay ƒë·ªïi ${trendPercent}% (kh√¥ng ƒë√°ng k·ªÉ)`;
                    document.getElementById('statTrend').className = 'stat-value';
                    document.getElementById('statTrend').style.color = '#d1d5db';
                }
            } else {
                document.getElementById('statTrend').textContent = 'Ch∆∞a ƒë·ªß d·ªØ li·ªáu';
                document.getElementById('statTrendLabel').textContent = 'C·∫ßn √≠t nh·∫•t 6 th√°ng';
            }
            
            // 5. S·ªë th√°ng c√≥ d·ªØ li·ªáu (ch·ªâ ƒë·∫øm th√°ng c√≥ data, kh√¥ng t√≠nh th√°ng 0)
            document.getElementById('statTotalMonths').textContent = monthsWithData + ' th√°ng';
            
            // 6. Trung b√¨nh ti·∫øt ki·ªám/ng√†y - T√≠nh ch√≠nh x√°c theo s·ªë ng√†y th·ª±c t·∫ø
            // T√≠nh t·ªïng s·ªë ng√†y d·ª±a tr√™n c√°c th√°ng c√≥ d·ªØ li·ªáu
            let totalDays = 0;
            const monthsWithDataDetails = monthlyDetails.filter(m => m.load > 0 || m.grid > 0 || m.backup > 0);
            
            monthsWithDataDetails.forEach(m => {
                // Parse th√°ng t·ª´ "Th√°ng X/YYYY"
                const match = m.month.match(/Th√°ng (\d+)\/(\d+)/);
                if (match) {
                    const monthNum = parseInt(match[1]);
                    const year = parseInt(match[2]);
                    // S·ªë ng√†y trong th√°ng
                    const daysInMonth = new Date(year, monthNum, 0).getDate();
                    totalDays += daysInMonth;
                } else {
                    totalDays += 30; // Fallback
                }
            });
            
            // N·∫øu kh√¥ng t√≠nh ƒë∆∞·ª£c, d√πng ∆∞·ªõc l∆∞·ª£ng 30 ng√†y/th√°ng
            if (totalDays === 0 && monthsWithData > 0) {
                totalDays = monthsWithData * 30;
            }
            
            const avgSavingsPerDay = totalDays > 0 ? totalSavings / totalDays : 0;
            document.getElementById('statAvgSavings').textContent = formatVND(avgSavingsPerDay);
            document.getElementById('statAvgSavingsLabel').textContent = `T√≠nh tr√™n ${totalDays} ng√†y (${monthsWithData} th√°ng)`;
            
            // 7. Th√°ng Solar s·∫£n xu·∫•t nhi·ªÅu nh·∫•t
            let bestSolarMonth = monthlyDetails[0];
            monthlyDetails.forEach(month => {
                if (month.solarProduced > bestSolarMonth.solarProduced) bestSolarMonth = month;
            });
            document.getElementById('statBestSolarMonth').textContent = bestSolarMonth.month;
            document.getElementById('statBestSolarValue').textContent = formatKWh(bestSolarMonth.solarProduced);
            
            // 8. T·ª∑ l·ªá t·ª± cung t·ª± c·∫•p (Solar / Load)
            const selfSufficiency = totalLoad > 0 ? ((totalSolar / totalLoad) * 100).toFixed(1) : 0;
            document.getElementById('statSelfSufficiency').textContent = selfSufficiency + '%';
        }
        // ==================== END QUICK STATS ====================

        // T√≠nh to√°n ROI (Return on Investment)
        // C√¥ng th·ª©c c∆° b·∫£n:
        // - Ti·∫øt ki·ªám TB/th√°ng = T·ªïng ti·∫øt ki·ªám / S·ªë th√°ng c√≥ d·ªØ li·ªáu
        // - Th·ªùi gian ho√†n v·ªën (th√°ng) = Chi ph√≠ l·∫Øp ƒë·∫∑t / Ti·∫øt ki·ªám TB/th√°ng
        // - C√≤n ph·∫£i thu h·ªìi = Chi ph√≠ - ƒê√£ ti·∫øt ki·ªám
        // - % Ho√†n v·ªën = (ƒê√£ ti·∫øt ki·ªám / Chi ph√≠) √ó 100
        //
        // M·ªü r·ªông cho nhi·ªÅu nƒÉm:
        // - N·∫øu c√≥ 24 th√°ng data (2 nƒÉm): monthsWithData = 24
        // - N·∫øu c√≥ 36 th√°ng data (3 nƒÉm): monthsWithData = 36
        // - C√¥ng th·ª©c v·∫´n gi·ªØ nguy√™n, ch·ªâ thay ƒë·ªïi monthsWithData
        function calculateROI(totalSavings, monthsWithData) {
            const initialCost = getInitialCostValue();
            
            if (initialCost <= 0) {
                document.getElementById('roiSection').style.display = 'none';
                return;
            }

            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√°ng n√†o, ·∫©n ROI
            if (monthsWithData <= 0) {
                document.getElementById('roiSection').style.display = 'none';
                return;
            }

            document.getElementById('roiSection').style.display = 'block';

            // S·ªë ti·ªÅn ƒë√£ ti·∫øt ki·ªám (d·ª±a tr√™n s·ªë th√°ng c√≥ data)
            const savedAmount = totalSavings;
            
            // S·ªë ti·ªÅn c√≤n ph·∫£i thu h·ªìi
            const remainingAmount = initialCost - savedAmount;
            
            // Ti·∫øt ki·ªám TB/th√°ng - CH·ªà T√çNH TR√äN S·ªê TH√ÅNG C√ì D·ªÆA LI·ªÜU
            const avgMonthlySavings = totalSavings / monthsWithData;
            
            // Th·ªùi gian ho√†n v·ªën (th√°ng)
            let paybackMonths = 0;
            let paybackNote = '';
            
            if (avgMonthlySavings > 0) {
                paybackMonths = initialCost / avgMonthlySavings;
                const years = Math.floor(paybackMonths / 12);
                const months = Math.round(paybackMonths % 12);
                
                if (years > 0) {
                    paybackNote = `(${years} nƒÉm ${months} th√°ng)`;
                } else {
                    paybackNote = '';
                }
            }
            
            // Ph·∫ßn trƒÉm ho√†n v·ªën
            const percentRecovered = Math.min((savedAmount / initialCost) * 100, 100);
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            document.getElementById('roiInitialCost').textContent = formatVND(initialCost);
            document.getElementById('roiSaved').textContent = formatVND(savedAmount);
            
            // Hi·ªÉn th·ªã s·ªë th√°ng ƒë√£ c√≥ data
            const yearsData = Math.floor(monthsWithData / 12);
            const monthsData = monthsWithData % 12;
            let dataNote = '';
            if (yearsData > 0) {
                dataNote = `(${yearsData} nƒÉm ${monthsData} th√°ng data)`;
            } else {
                dataNote = `(${monthsData} th√°ng data)`;
            }
            document.getElementById('roiSavedNote').textContent = dataNote;
            
            if (remainingAmount > 0) {
                document.getElementById('roiRemaining').textContent = formatVND(remainingAmount);
                const monthsNeeded = Math.ceil(remainingAmount / avgMonthlySavings);
                const yearsNeeded = (monthsNeeded / 12).toFixed(1);
                if (monthsNeeded > 12) {
                    document.getElementById('roiRemainingNote').textContent = `C·∫ßn th√™m ~${yearsNeeded} nƒÉm (${monthsNeeded} th√°ng)`;
                } else {
                    document.getElementById('roiRemainingNote').textContent = `C·∫ßn th√™m ${monthsNeeded} th√°ng`;
                }
                document.getElementById('roiRemainingNote').style.color = '#fbbf24';
                
                // ·∫®n card ti·ªÅn l·ªùi
                document.getElementById('roiProfitCard').style.display = 'none';
            } else {
                document.getElementById('roiRemaining').textContent = '0 ‚Ç´';
                document.getElementById('roiRemainingNote').textContent = '‚úÖ ƒê√£ ho√†n v·ªën!';
                document.getElementById('roiRemainingNote').style.color = '#4ade80';
                
                // Hi·ªÉn th·ªã ti·ªÅn l·ªùi
                const profit = savedAmount - initialCost;
                document.getElementById('roiProfit').textContent = formatVND(profit);
                
                // T√≠nh th·ªùi gian ƒë√£ c√≥ l·ªùi
                const profitMonths = Math.floor(profit / avgMonthlySavings);
                const profitYears = (profitMonths / 12).toFixed(1);
                if (profitMonths > 12) {
                    document.getElementById('roiProfitNote').textContent = `L·ªùi sau ${profitYears} nƒÉm ho√†n v·ªën`;
                } else {
                    document.getElementById('roiProfitNote').textContent = `L·ªùi sau ${profitMonths} th√°ng ho√†n v·ªën`;
                }
                document.getElementById('roiProfitNote').style.color = '#10b981';
                
                // Hi·ªÉn card ti·ªÅn l·ªùi
                document.getElementById('roiProfitCard').style.display = 'block';
            }
            
            if (paybackMonths > 0) {
                if (paybackMonths <= 12) {
                    document.getElementById('roiTime').textContent = `${Math.round(paybackMonths)} th√°ng`;
                    document.getElementById('roiTimeNote').textContent = '';
                } else {
                    const years = (paybackMonths / 12).toFixed(1);
                    const totalMonths = Math.round(paybackMonths);
                    document.getElementById('roiTime').textContent = `${years} nƒÉm`;
                    document.getElementById('roiTimeNote').textContent = `(${totalMonths} th√°ng)`;
                }
            } else {
                document.getElementById('roiTime').textContent = '‚àû';
                document.getElementById('roiTimeNote').textContent = 'Kh√¥ng ti·∫øt ki·ªám';
            }
            
            // C·∫≠p nh·∫≠t thanh progress
            const progressFill = document.getElementById('roiProgressFill');
            const progressText = document.getElementById('roiProgressText');
            const percentText = `${percentRecovered.toFixed(1)}%`;
            
            progressFill.style.width = `${percentRecovered}%`;
            progressText.textContent = percentText;
            
            // ƒê·ªïi m√†u thanh progress d·ª±a tr√™n %
            let progressColor = 'linear-gradient(90deg, #ef4444, #f87171, #fca5a5)';
            if (percentRecovered >= 100) {
                progressColor = 'linear-gradient(90deg, #10b981, #34d399, #6ee7b7)';
            } else if (percentRecovered >= 75) {
                progressColor = 'linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd)';
            } else if (percentRecovered >= 50) {
                progressColor = 'linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d)';
            }
            progressFill.style.background = progressColor;
            
            // ========== MOBILE COMPACT ROI UPDATE ==========
            // C·∫≠p nh·∫≠t input mobile (sync v·ªõi desktop)
            const mobileInput = document.getElementById('initialCostMobile');
            if (mobileInput) {
                mobileInput.value = formatNumber(initialCost.toString());
            }
            
            // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã mini
            document.getElementById('roiMiniCost').textContent = formatVND(initialCost);
            document.getElementById('roiMiniSaved').textContent = formatVND(savedAmount);
            document.getElementById('roiMiniSavedNote').textContent = dataNote;
            
            if (remainingAmount > 0) {
                document.getElementById('roiMiniRemaining').textContent = formatVND(remainingAmount);
                const monthsNeeded = Math.ceil(remainingAmount / avgMonthlySavings);
                const yearsNeeded = (monthsNeeded / 12).toFixed(1);
                if (monthsNeeded > 12) {
                    document.getElementById('roiMiniRemainingNote').textContent = `~${yearsNeeded} nƒÉm n·ªØa`;
                } else {
                    document.getElementById('roiMiniRemainingNote').textContent = `${monthsNeeded} th√°ng n·ªØa`;
                }
                document.getElementById('roiMiniProfitCard').style.display = 'none';
            } else {
                document.getElementById('roiMiniRemaining').textContent = '0 ‚Ç´';
                document.getElementById('roiMiniRemainingNote').textContent = '‚úÖ Done!';
                
                // Hi·ªÉn th·ªã ti·ªÅn l·ªùi tr√™n mobile
                const profit = savedAmount - initialCost;
                document.getElementById('roiMiniProfit').textContent = formatVND(profit);
                const profitMonths = Math.floor(profit / avgMonthlySavings);
                const profitYears = (profitMonths / 12).toFixed(1);
                document.getElementById('roiMiniProfitNote').textContent = profitMonths > 12 ? `Sau ${profitYears} nƒÉm` : `Sau ${profitMonths} th√°ng`;
                document.getElementById('roiMiniProfitCard').style.display = 'block';
            }
            
            // Th·ªùi gian ho√†n v·ªën mobile
            if (paybackMonths > 0) {
                if (paybackMonths <= 12) {
                    document.getElementById('roiMiniTime').textContent = `${Math.round(paybackMonths)} th√°ng`;
                    document.getElementById('roiMiniTimeNote').textContent = '';
                } else {
                    const years = (paybackMonths / 12).toFixed(1);
                    document.getElementById('roiMiniTime').textContent = `${years} nƒÉm`;
                    document.getElementById('roiMiniTimeNote').textContent = `‚âà ${Math.round(paybackMonths)} th√°ng`;
                }
            } else {
                document.getElementById('roiMiniTime').textContent = '‚àû';
                document.getElementById('roiMiniTimeNote').textContent = '';
            }
            
            // Mini progress bar
            document.getElementById('roiMiniProgressFill').style.width = `${percentRecovered}%`;
            document.getElementById('roiMiniProgressText').textContent = percentText;
            document.getElementById('roiMiniProgressFill').style.background = progressColor;
        }

        // V·∫Ω bi·ªÉu ƒë·ªì ti·∫øt ki·ªám
        function drawChart(data) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: getMonthNames(),
                    datasets: [{
                        label: 'Ti·ªÅn ƒëi·ªán ti·∫øt ki·ªám (VNƒê)',
                        data: data,
                        backgroundColor: 'rgba(74, 222, 128, 0.8)',
                        borderColor: 'rgba(74, 222, 128, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#4ade80',
                            bodyColor: '#fff',
                            borderColor: '#4ade80',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Ti·∫øt ki·ªám: ' + formatVND(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e0',
                                callback: function(value) {
                                    return formatVND(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // V·∫Ω bi·ªÉu ƒë·ªì solar production
        let solarChart = null;
        function drawSolarChart(data) {
            const ctx = document.getElementById('solarChart').getContext('2d');
            
            if (solarChart) {
                solarChart.destroy();
            }

            solarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: getMonthNames(),
                    datasets: [{
                        label: 'ƒêi·ªán Solar S·∫£n Xu·∫•t (kWh)',
                        data: data,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#22c55e',
                            bodyColor: '#fff',
                            borderColor: '#22c55e',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Solar: ' + formatKWh(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e0',
                                callback: function(value) {
                                    return formatKWh(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Hi·ªÉn th·ªã chi ti·∫øt - V·ªõi ph√¢n trang, m·ªói h√†ng 6 th√°ng
        function displayDetails(details) {
            // L∆∞u t·∫•t c·∫£ chi ti·∫øt
            allMonthlyDetails = details;
            
            // C·∫≠p nh·∫≠t info
            document.getElementById('detailsMonthCountInfo').textContent = `üìÖ Hi·ªán c√≥ ${details.length} th√°ng`;
            
            // Hi·ªÉn th·ªã trang hi·ªán t·∫°i
            displayDetailsPage(currentDetailsPage);
        }
        
        // Hi·ªÉn th·ªã m·ªôt trang chi ti·∫øt
        function displayDetailsPage(page) {
            const container = document.getElementById('monthDetails');
            container.innerHTML = '';
            
            // T√≠nh to√°n ph·∫°m vi
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            currentDetailsPage = Math.max(1, Math.min(page, totalPages));
            
            const startIndex = (currentDetailsPage - 1) * DETAILS_MONTHS_PER_PAGE;
            const endIndex = Math.min(startIndex + DETAILS_MONTHS_PER_PAGE, allMonthlyDetails.length);
            const pageDetails = allMonthlyDetails.slice(startIndex, endIndex);

            // T·∫°o container cho c√°c h√†ng
            const rowsContainer = document.createElement('div');
            rowsContainer.className = 'details-rows-container';

            // Chia th√†nh c√°c h√†ng, m·ªói h√†ng 6 th√°ng
            const MONTHS_PER_ROW = 6;
            const totalRows = Math.ceil(pageDetails.length / MONTHS_PER_ROW);

            for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
                const rowStartIndex = rowIndex * MONTHS_PER_ROW;
                const rowEndIndex = Math.min(rowStartIndex + MONTHS_PER_ROW, pageDetails.length);
                const rowMonths = pageDetails.slice(rowStartIndex, rowEndIndex);

                // T·∫°o h√†ng
                const row = document.createElement('div');
                row.className = 'details-row';
                
                rowMonths.forEach(detail => {
                    row.appendChild(createDetailCard(detail));
                });
                
                rowsContainer.appendChild(row);
            }

            container.appendChild(rowsContainer);
            
            // C·∫≠p nh·∫≠t pagination UI
            updateDetailsPagination();
        }
        
        // C·∫≠p nh·∫≠t UI pagination cho chi ti·∫øt
        function updateDetailsPagination() {
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            const pageInfo = `Trang ${currentDetailsPage}/${totalPages} (Th√°ng ${(currentDetailsPage-1)*DETAILS_MONTHS_PER_PAGE+1}-${Math.min(currentDetailsPage*DETAILS_MONTHS_PER_PAGE, allMonthlyDetails.length)})`;
            
            document.getElementById('detailsPageInfo').textContent = pageInfo;
            document.getElementById('detailsPageInfoBottom').textContent = pageInfo;
            
            // Disable/enable buttons
            const prevButtons = document.querySelectorAll('#detailsPaginationTop button:first-child, #detailsPaginationBottom button:first-child');
            const nextButtons = document.querySelectorAll('#detailsPaginationTop button:last-child, #detailsPaginationBottom button:last-child');
            
            prevButtons.forEach(btn => btn.disabled = currentDetailsPage === 1);
            nextButtons.forEach(btn => btn.disabled = currentDetailsPage === totalPages);
        }
        
        // Chuy·ªÉn trang chi ti·∫øt
        function nextDetailsPage() {
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            if (currentDetailsPage < totalPages) {
                displayDetailsPage(currentDetailsPage + 1);
            }
        }
        
        function previousDetailsPage() {
            if (currentDetailsPage > 1) {
                displayDetailsPage(currentDetailsPage - 1);
            }
        }

        // T·∫°o card chi ti·∫øt cho m·ªôt th√°ng - Compact version with tooltip
        function createDetailCard(detail) {
            const card = document.createElement('div');
            card.className = 'detail-card';
            
            // Determine emoji based on month
            const monthEmojis = {
                1: '‚ùÑÔ∏è', 2: 'üå∏', 3: 'üåº', 4: 'üå∑',
                5: '‚òÄÔ∏è', 6: 'üåû', 7: 'üî•', 8: 'üåà',
                9: 'üçÇ', 10: 'üçÅ', 11: 'üåô', 12: 'üéÑ'
            };
            
            // Extract month number from detail.month (e.g., "Th√°ng 9/2025" -> 9)
            const monthMatch = detail.month.match(/Th√°ng (\d+)/);
            const monthNum = monthMatch ? parseInt(monthMatch[1]) : 1;
            const emoji = monthEmojis[monthNum] || 'üìÖ';
            
            card.innerHTML = `
                <div class="detail-card-tooltip">
                    <span class="emoji">${emoji}</span>
                    <span>${detail.month}</span>
                </div>
                
                <h4>${detail.month}</h4>
                
                <div class="detail-row-item">
                    <span class="label">Load:</span>
                    <span class="value">${formatKWh(detail.load)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Grid:</span>
                    <span class="value">${formatKWh(detail.grid)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Backup:</span>
                    <span class="value">${formatKWh(detail.backup)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">M·∫∑t tr·ªùi:</span>
                    <span class="value">${formatKWh(detail.solarProduced)}</span>
                </div>
                
                <div class="detail-row-item section-header">
                    <span>üí∞ Chi Ph√≠</span>
                    <span></span>
                </div>
                
                <div class="detail-row-item grid-cost">
                    <span class="label">EVN:</span>
                    <span class="value">${formatVND(detail.gridCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Solar:</span>
                    <span class="value">${formatVND(detail.solarCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Th·ª±c t·∫ø:</span>
                    <span class="value">${formatVND(detail.actualCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Kh√¥ng solar:</span>
                    <span class="value">${formatVND(detail.costWithoutSolar)}</span>
                </div>
                
                <div class="detail-row-item highlight">
                    <span>üî• Ti·∫øt ki·ªám:</span>
                    <span>${formatVND(detail.savings)}</span>
                </div>
            `;
            return card;
        }

        // ƒê·∫∑t l·∫°i d·ªØ li·ªáu
        function resetData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) {
                for (let i = 0; i < 12; i++) {
                    document.getElementById(`load${i}`).value = 0;
                    document.getElementById(`grid${i}`).value = 0;
                    document.getElementById(`backup${i}`).value = 0;
                }
                
                document.getElementById('totalSavings').textContent = '0 ‚Ç´';
                document.getElementById('totalLoad').textContent = '0 kWh';
                document.getElementById('totalSolar').textContent = '0 kWh';
                document.getElementById('totalGrid').textContent = '0 kWh';
                document.getElementById('totalCostWithoutSolar').textContent = '0 ‚Ç´';
                document.getElementById('avgSavings').textContent = '0 ‚Ç´';
                document.getElementById('avgLoad').textContent = '0 kWh';
                document.getElementById('avgSolar').textContent = '0 kWh';
                document.getElementById('avgGrid').textContent = '0 kWh';
                document.getElementById('avgCostWithoutSolar').textContent = '0 ‚Ç´';
                document.getElementById('monthDetails').innerHTML = '';
                
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                
                if (solarChart) {
                    solarChart.destroy();
                    solarChart = null;
                }

                showNotification('üîÑ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'info');
            }
        }

        // B·ªè h√†m setupPriceListeners - kh√¥ng c√≤n c·∫ßn

        // Kh·ªüi t·∫°o khi trang load
        window.onload = function() {
            initializeInputs();
            updateStorageStatus();
            setupInitialCostInput(); // Setup auto-format cho initialCost
            
            // T·ª± ƒë·ªông t·∫£i c√†i ƒë·∫∑t n·∫øu c√≥
            const savedSettings = localStorage.getItem('solarSettings');
            if (savedSettings) {
                loadSettings();
            } else {
                // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u, t·∫£i demo
                loadDemoData();
            }
        };
    </script>

    <!-- EVN Calculator Modal -->
    <div id="evnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö° T√≠nh Ti·ªÅn ƒêi·ªán EVN (B·∫≠c Thang)</h2>
                <button class="modal-close" onclick="closeEVNModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #cbd5e0; margin-bottom: 20px; font-size: 0.95em;">
                    Ki·ªÉm tra chi ph√≠ ƒëi·ªán theo 6 b·∫≠c gi√° ƒëi·ªán ch√≠nh th·ª©c c·ªßa EVN + VAT 8%
                </p>
                
                <div class="evn-warning">
                    <strong>üìå L∆∞u √Ω:</strong> ƒê√¢y l√† c√¥ng c·ª• t√≠nh to√°n b·∫≠c thang gi√° ƒëi·ªán. 
                    K·∫øt qu·∫£ ph·∫£i kh·ªõp v·ªõi h√≥a ƒë∆°n EVN th·ª±c t·∫ø!
                </div>
                
                <h3 style="margin-bottom: 15px; color: #4ade80; font-size: 1.1em;">üìä B·∫≠c Thang Gi√° ƒêi·ªán EVN</h3>
                <table class="evn-tier-table">
                    <thead>
                        <tr>
                            <th>B·∫≠c</th>
                            <th>M·ª©c ti√™u th·ª•</th>
                            <th>Gi√° (ƒë·ªìng/kWh)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 1</span></td>
                            <td>0 - 50 kWh</td>
                            <td><span class="evn-price">1,984</span></td>
                        </tr>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 2</span></td>
                            <td>51 - 100 kWh</td>
                            <td><span class="evn-price">2,050</span></td>
                        </tr>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 3</span></td>
                            <td>101 - 200 kWh</td>
                            <td><span class="evn-price">2,380</span></td>
                        </tr>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 4</span></td>
                            <td>201 - 300 kWh</td>
                            <td><span class="evn-price">2,998</span></td>
                        </tr>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 5</span></td>
                            <td>301 - 400 kWh</td>
                            <td><span class="evn-price">3,350</span></td>
                        </tr>
                        <tr>
                            <td><span class="evn-tier-number">B·∫≠c 6</span></td>
                            <td>401+ kWh</td>
                            <td><span class="evn-price">3,460</span></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="evn-input-section">
                    <h3>üî¢ Nh·∫≠p S·ªë ƒêi·ªán Ti√™u Th·ª•</h3>
                    <div class="evn-input-group">
                        <label for="evnKwh">ƒêi·ªán ti√™u th·ª• (kWh):</label>
                        <input type="number" id="evnKwh" placeholder="V√≠ d·ª•: 350" min="0" step="0.1">
                    </div>
                    <button class="evn-btn-calculate" onclick="calculateEVN()">üßÆ T√≠nh To√°n</button>
                </div>
                
                <div class="evn-result-section" id="evnResultSection">
                    <h3 style="margin-bottom: 15px; color: #4ade80; font-size: 1.1em;">üìã Chi Ti·∫øt T√≠nh To√°n</h3>
                    <div class="evn-breakdown" id="evnBreakdown"></div>
                    <div class="evn-final-result" id="evnFinalResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EVN Modal Functions
        function openEVNModal() {
            document.getElementById('evnModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeEVNModal() {
            document.getElementById('evnModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('evnModal');
            if (event.target == modal) {
                closeEVNModal();
            }
        }

        // ESC key to close
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEVNModal();
            }
        });

        function calculateEVNTier(kWh) {
            if (kWh <= 0) return { total: 0, breakdown: [] };
            
            const breakdown = [];
            let totalCost = 0;
            let remaining = kWh;
            
            // B·∫≠c 1: 0 - 50 kWh = 1,984 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier1 = Math.min(remaining, 50);
                const cost1 = tier1 * 1984;
                totalCost += cost1;
                breakdown.push({
                    tier: 1,
                    range: '0-50 kWh',
                    kwh: tier1,
                    price: 1984,
                    cost: cost1
                });
                remaining -= tier1;
            }
            
            // B·∫≠c 2: 51 - 100 kWh = 2,050 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier2 = Math.min(remaining, 50);
                const cost2 = tier2 * 2050;
                totalCost += cost2;
                breakdown.push({
                    tier: 2,
                    range: '51-100 kWh',
                    kwh: tier2,
                    price: 2050,
                    cost: cost2
                });
                remaining -= tier2;
            }
            
            // B·∫≠c 3: 101 - 200 kWh = 2,380 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier3 = Math.min(remaining, 100);
                const cost3 = tier3 * 2380;
                totalCost += cost3;
                breakdown.push({
                    tier: 3,
                    range: '101-200 kWh',
                    kwh: tier3,
                    price: 2380,
                    cost: cost3
                });
                remaining -= tier3;
            }
            
            // B·∫≠c 4: 201 - 300 kWh = 2,998 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier4 = Math.min(remaining, 100);
                const cost4 = tier4 * 2998;
                totalCost += cost4;
                breakdown.push({
                    tier: 4,
                    range: '201-300 kWh',
                    kwh: tier4,
                    price: 2998,
                    cost: cost4
                });
                remaining -= tier4;
            }
            
            // B·∫≠c 5: 301 - 400 kWh = 3,350 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier5 = Math.min(remaining, 100);
                const cost5 = tier5 * 3350;
                totalCost += cost5;
                breakdown.push({
                    tier: 5,
                    range: '301-400 kWh',
                    kwh: tier5,
                    price: 3350,
                    cost: cost5
                });
                remaining -= tier5;
            }
            
            // B·∫≠c 6: 401+ kWh = 3,460 ƒë·ªìng/kWh
            if (remaining > 0) {
                const cost6 = remaining * 3460;
                totalCost += cost6;
                breakdown.push({
                    tier: 6,
                    range: '401+ kWh',
                    kwh: remaining,
                    price: 3460,
                    cost: cost6
                });
            }
            
            // √Åp d·ª•ng VAT 8%
            const vatRate = 0.08;
            const totalWithVAT = totalCost * (1 + vatRate);
            
            return {
                totalBeforeVAT: totalCost,
                vat: totalCost * vatRate,
                total: totalWithVAT,
                breakdown: breakdown
            };
        }

        function calculateEVN() {
            const kWhInput = document.getElementById('evnKwh');
            const kWh = parseFloat(kWhInput.value);
            
            if (!kWh || kWh <= 0) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán ti√™u th·ª• h·ª£p l·ªá!', 'warning');
                return;
            }
            
            const result = calculateEVNTier(kWh);
            
            // Hi·ªÉn th·ªã breakdown
            const breakdownHtml = result.breakdown.map(item => `
                <div class="evn-breakdown-item">
                    <span class="evn-tier-label">
                        <strong>B·∫≠c ${item.tier}</strong> (${item.range}): 
                        ${item.kwh.toFixed(1)} kWh √ó ${item.price.toLocaleString()} ƒë
                    </span>
                    <span class="evn-tier-value">${formatVND(item.cost)}</span>
                </div>
            `).join('');
            
            const summaryHtml = `
                <div class="evn-breakdown-item">
                    <span class="evn-tier-label"><strong>T·ªïng tr∆∞·ªõc VAT:</strong></span>
                    <span class="evn-tier-value">${formatVND(result.totalBeforeVAT)}</span>
                </div>
                <div class="evn-breakdown-item">
                    <span class="evn-tier-label"><strong>VAT 8%:</strong></span>
                    <span class="evn-tier-value">${formatVND(result.vat)}</span>
                </div>
                <div class="evn-breakdown-item">
                    <span class="evn-tier-label"><strong>T·ªîNG C·ªòNG:</strong></span>
                    <span class="evn-tier-value">${formatVND(result.total)}</span>
                </div>
            `;
            
            document.getElementById('evnBreakdown').innerHTML = breakdownHtml + summaryHtml;
            document.getElementById('evnFinalResult').innerHTML = 
                `üí∞ Chi ph√≠ ƒëi·ªán: <span style="color: #4ade80;">${formatVND(result.total)}</span>`;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const resultSection = document.getElementById('evnResultSection');
            resultSection.classList.add('show');
        }

        // Enter key to calculate in modal
        document.addEventListener('DOMContentLoaded', function() {
            const evnInput = document.getElementById('evnKwh');
            if (evnInput) {
                evnInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        calculateEVN();
                    }
                });
                
                evnInput.addEventListener('focus', function() {
                    this.select();
                });
            }
        });
    </script>
    
    <!-- PWA disabled - use browser shortcut instead -->
    <!--
    <script>
        // Service Worker and PWA functionality disabled
        // Users can add to home screen as a regular browser shortcut
    </script>
    -->
    
    <!-- Lumentree Sync Modal -->
    <div id="lumentreeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h2>‚òÄÔ∏è ƒê·ªìng B·ªô T·ª´ Lumentree</h2>
                <button class="modal-close" onclick="closeLumentreeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #cbd5e0; margin-bottom: 20px; font-size: 0.95em;">
                    L·∫•y d·ªØ li·ªáu t·ª´ Lumentree Dashboard v·ªÅ ·ª©ng d·ª•ng
                </p>
                
                <!-- Tab buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="tabDashboard" class="evn-btn-calculate" onclick="switchLumentreeTab('dashboard')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        üè† T·ª´ Dashboard
                    </button>
                    <button id="tabAuto" class="evn-btn-calculate" onclick="switchLumentreeTab('auto')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        üîÑ T·ª´ Lumentree
                    </button>
                    <button id="tabManual" class="evn-btn-calculate" onclick="switchLumentreeTab('manual')" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        üìã Th·ªß C√¥ng
                    </button>
                </div>
                
                <!-- Tab Dashboard (Proxy to Lumentree) -->
                <div id="lumentreeTabDashboard">
                    <div class="evn-warning" style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.15); color: #fbbf24;">
                        <strong>‚ö° L·∫•y d·ªØ li·ªáu nhanh:</strong> Proxy qua server, kh√¥ng b·ªã ch·∫∑n CORS.<br>
                        L·∫•y to√†n b·ªô d·ªØ li·ªáu t·ª´ Lumentree.net m·ªôt c√°ch nhanh ch√≥ng.
                    </div>
                    
                    <div class="evn-input-section" style="border-color: #f59e0b;">
                        <h3 style="color: #f59e0b;">üîó K·∫øt N·ªëi Qua Dashboard</h3>
                        <div class="evn-input-group">
                            <label for="dashboardDeviceId">Device ID:</label>
                            <input type="text" id="dashboardDeviceId" placeholder="V√≠ d·ª•: P250801055" style="text-transform: uppercase;">
                        </div>
                        <button class="evn-btn-calculate" onclick="fetchDashboardData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ‚ö° L·∫•y To√†n B·ªô D·ªØ Li·ªáu
                        </button>
                        <div style="margin: 12px 0 0 0; font-size: 0.75em; color: #9ca3af; text-align: left; line-height: 1.6;">
                            <p style="margin: 0;">‚ö° <em>Nhanh v√† ·ªïn ƒë·ªãnh - L·∫•y tr·ª±c ti·∫øp qua server proxy</em></p>
                            <p style="margin: 6px 0 0 0;">üìä <em>L·∫•y to√†n b·ªô d·ªØ li·ªáu c√≥ s·∫µn t·ª´ Lumentree.net</em></p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Auto -->
                <div id="lumentreeTabAuto" style="display: none;">
                    <div class="evn-warning" style="border-color: #10b981; background: rgba(16, 185, 129, 0.15); color: #6ee7b7;">
                        <strong>üìå T·ª´ Lumentree.net:</strong> Nh·∫≠p Device ID ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ server Lumentree.<br>
                        VD: URL <code>lumentree.net/dashboard/P250801055</code> ‚Üí ID l√† <code>P250801055</code>
                    </div>
                    
                    <div class="evn-input-section" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">üîó K·∫øt N·ªëi Lumentree</h3>
                        <div class="evn-input-group">
                            <label for="lumentreeDeviceId">Device ID:</label>
                            <input type="text" id="lumentreeDeviceId" placeholder="V√≠ d·ª•: P250801055" style="text-transform: uppercase;">
                        </div>
                        <button class="evn-btn-calculate" onclick="fetchLumentreeData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            üîÑ L·∫•y D·ªØ Li·ªáu
                        </button>
                        <div style="margin: 12px 0 0 0; font-size: 0.75em; color: #9ca3af; text-align: left; line-height: 1.6;">
                            <p style="margin: 0 0 6px 0;">üí° <em>N·∫øu ch∆∞a c√≥ data, h√£y v√†o <a href="https://lumentree.net" target="_blank" style="color: #10b981; text-decoration: underline;">lumentree.net</a> ƒë·ªÉ k√≠ch ho·∫°t ID thi·∫øt b·ªã tr∆∞·ªõc, ch·ªù 5-10 ph√∫t r·ªìi th·ª≠ l·∫°i.</em></p>
                            <p style="margin: 0;">üîÑ <em>N·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c, h√£y th·ª≠ l·∫°i 4-5 l·∫ßn ho·∫∑c chuy·ªÉn sang tab <strong style="color: #f59e0b;">üìã Th·ªß C√¥ng</strong></em></p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Manual -->
                <div id="lumentreeTabManual" style="display: none;">
                    <div class="evn-warning" style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.15); color: #fbbf24;">
                        <strong>üìå H∆∞·ªõng d·∫´n l·∫•y d·ªØ li·ªáu th·ªß c√¥ng:</strong><br>
                        1. Nh·∫≠p Device ID v√† b·∫•m n√∫t "M·ªü Link API":<br>
                        <div style="display: flex; gap: 8px; align-items: center; margin: 8px 0;">
                            <input type="text" id="manualDeviceId" placeholder="VD: P250801050" 
                                style="flex: 1; padding: 8px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: rgba(0,0,0,0.3); color: #fbbf24; font-family: monospace; font-weight: bold;">
                            <button onclick="openLumentreeAPI()" style="padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; white-space: nowrap;">
                                üîó M·ªü Link API
                            </button>
                        </div>
                        2. B·∫•m <kbd>Ctrl+A</kbd> ƒë·ªÉ ch·ªçn t·∫•t c·∫£, <kbd>Ctrl+C</kbd> ƒë·ªÉ copy<br>
                        3. Quay l·∫°i ƒë√¢y v√† Paste v√†o √¥ b√™n d∆∞·ªõi b·∫±ng <kbd>Ctrl+V</kbd>
                    </div>
                    
                    <div class="evn-input-section" style="border-color: #f59e0b;">
                        <h3 style="color: #f59e0b;">üìã Paste JSON Data</h3>
                        <div class="evn-input-group">
                            <label for="lumentreeJsonInput">D·ªØ li·ªáu JSON t·ª´ Lumentree:</label>
                            <textarea id="lumentreeJsonInput" placeholder='[{"month":"2025-10","load":827.4,"grid":236.0,"pv":686.0,"backup":0.4}, ...]' style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #4a5568; border-radius: 10px; background: rgba(26, 32, 44, 0.8); color: #e2e8f0; font-family: monospace; font-size: 0.85em; resize: vertical;"></textarea>
                        </div>
                        <button class="evn-btn-calculate" onclick="parseManualLumentreeData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            üì• X·ª≠ L√Ω D·ªØ Li·ªáu
                        </button>
                    </div>
                </div>
                
                <div class="evn-result-section" id="lumentreeResultSection">
                    <h3 style="margin-bottom: 15px; color: #10b981; font-size: 1.1em;">üìã D·ªØ Li·ªáu T·ª´ Lumentree</h3>
                    <div id="lumentreePreview"></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="evn-btn-calculate" onclick="importLumentreeData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); flex: 1;">
                            ‚úÖ Nh·∫≠p V√†o ·ª®ng D·ª•ng
                        </button>
                        <button class="evn-btn-calculate" onclick="closeLumentreeModal()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); flex: 1;">
                            ‚ùå H·ªßy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== LUMENTREE SYNC ====================
        let lumentreeData = null;
        
        function openLumentreeModal() {
            document.getElementById('lumentreeModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Load saved device ID
            const savedDeviceId = localStorage.getItem('lumentreeDeviceId');
            if (savedDeviceId) {
                document.getElementById('dashboardDeviceId').value = savedDeviceId;
                document.getElementById('lumentreeDeviceId').value = savedDeviceId;
                document.getElementById('manualDeviceId').value = savedDeviceId;
            }
            
            // Also try to get deviceId from URL
            const urlParams = new URLSearchParams(window.location.search);
            const deviceIdParam = urlParams.get('deviceId');
            if (deviceIdParam) {
                document.getElementById('dashboardDeviceId').value = deviceIdParam;
                document.getElementById('lumentreeDeviceId').value = deviceIdParam;
                document.getElementById('manualDeviceId').value = deviceIdParam;
            }
        }
        
        // M·ªü link API trong tab m·ªõi
        function openLumentreeAPI() {
            let deviceId = document.getElementById('manualDeviceId').value.trim().toUpperCase();
            if (!deviceId) {
                // Fallback to auto tab device ID
                deviceId = document.getElementById('lumentreeDeviceId').value.trim().toUpperCase();
            }
            if (!deviceId) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Device ID!', 'error');
                return;
            }
            // Save device ID
            localStorage.setItem('lumentreeDeviceId', deviceId);
            document.getElementById('lumentreeDeviceId').value = deviceId;
            
            const apiUrl = `https://lumentree.net/api/monthly/${deviceId}`;
            window.open(apiUrl, '_blank');
            showNotification(`üîó ƒê√£ m·ªü API cho thi·∫øt b·ªã ${deviceId}. Copy d·ªØ li·ªáu v√† paste v√†o √¥ b√™n d∆∞·ªõi!`, 'info');
        }
        
        function closeLumentreeModal() {
            document.getElementById('lumentreeModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        
        async function fetchLumentreeData() {
            const deviceId = document.getElementById('lumentreeDeviceId').value.trim().toUpperCase();
            
            if (!deviceId) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Device ID!', 'error');
                return;
            }
            
            // Save device ID
            localStorage.setItem('lumentreeDeviceId', deviceId);
            
            try {
                showNotification('üîÑ ƒêang l·∫•y d·ªØ li·ªáu t·ª´ Lumentree...', 'info');
                
                // S·ª≠ d·ª•ng CORS proxy ƒë·ªÉ bypass CORS restriction
                const targetUrl = `https://lumentree.net/api/monthly/${deviceId}`;
                
                // Th·ª≠ nhi·ªÅu proxy kh√°c nhau (theo th·ª© t·ª± ∆∞u ti√™n - nhanh nh·∫•t tr∆∞·ªõc)
                const proxies = [
                    { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`, name: 'codetabs' },
                    { url: `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`, name: 'corsproxy.io' },
                    { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`, name: 'allorigins-raw' },
                    { url: `https://proxy.cors.sh/${targetUrl}`, name: 'cors.sh' },
                    { url: `https://crossorigin.me/${targetUrl}`, name: 'crossorigin.me' }
                ];
                
                let data = null;
                let lastError = null;
                
                // Helper function v·ªõi timeout
                const fetchWithTimeout = (url, timeout = 8000) => {
                    return Promise.race([
                        fetch(url, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), timeout)
                        )
                    ]);
                };
                
                for (const proxy of proxies) {
                    try {
                        console.log(`üîÑ Trying proxy: ${proxy.name}`);
                        const startTime = Date.now();
                        
                        const response = await fetchWithTimeout(proxy.url, 8000);
                        
                        if (!response.ok) {
                            console.log(`‚ùå ${proxy.name}: HTTP ${response.status}`);
                            continue;
                        }
                        
                        let text = await response.text();
                        
                        // Check if it's valid JSON array
                        if (text.trim().startsWith('[')) {
                            data = JSON.parse(text);
                            const elapsed = Date.now() - startTime;
                            console.log(`‚úÖ Success with ${proxy.name} in ${elapsed}ms`);
                            showNotification(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng qua ${proxy.name} (${elapsed}ms)`, 'success');
                            break;
                        } else {
                            console.log(`‚ùå ${proxy.name}: Invalid response format`);
                        }
                    } catch (e) {
                        lastError = e;
                        console.log(`‚ùå ${proxy.name}: ${e.message}`);
                        continue;
                    }
                }
                
                if (!data) {
                    // N·∫øu t·∫•t c·∫£ proxy ƒë·ªÅu fail, g·ª£i √Ω d√πng tab th·ªß c√¥ng
                    throw new Error(`Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ª± ƒë·ªông. Vui l√≤ng chuy·ªÉn sang tab "üìã Th·ªß C√¥ng" v√† paste d·ªØ li·ªáu JSON.`);
                }
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã n√†y');
                }
                
                lumentreeData = data;
                
                // Filter only months with data
                const monthsWithData = data.filter(m => m.load > 0 || m.grid > 0 || m.pv > 0);
                
                // Display preview
                let previewHtml = `
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 1.1em; font-weight: bold; color: #10b981; margin-bottom: 10px;">
                            üì° Thi·∫øt b·ªã: ${deviceId}
                        </div>
                        <div style="color: #cbd5e0;">
                            üìÖ T√¨m th·∫•y <strong>${monthsWithData.length}</strong> th√°ng c√≥ d·ªØ li·ªáu
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: rgba(16, 185, 129, 0.2);">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #10b981;">Th√°ng</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #10b981;">Load</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #10b981;">Grid</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #10b981;">PV</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #10b981;">Backup</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(m => {
                    const hasData = m.load > 0 || m.grid > 0 || m.pv > 0;
                    const rowStyle = hasData ? '' : 'opacity: 0.4;';
                    previewHtml += `
                        <tr style="${rowStyle}">
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568;">${m.month}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.load.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.grid.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right; color: #10b981;">${m.pv.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.backup.toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                previewHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('lumentreePreview').innerHTML = previewHtml;
                document.getElementById('lumentreeResultSection').classList.add('show');
                
                showNotification(`‚úÖ ƒê√£ l·∫•y d·ªØ li·ªáu ${monthsWithData.length} th√°ng t·ª´ Lumentree!`, 'success');
                
            } catch (error) {
                console.error('Lumentree fetch error:', error);
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }
        
        function importLumentreeData() {
            if (!lumentreeData || lumentreeData.length === 0) {
                showNotification('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ nh·∫≠p!', 'error');
                return;
            }
            
            // Filter months with data
            const monthsWithData = lumentreeData.filter(m => m.load > 0 || m.grid > 0 || m.pv > 0);
            
            if (monthsWithData.length === 0) {
                showNotification('‚ö†Ô∏è Kh√¥ng c√≥ th√°ng n√†o c√≥ d·ªØ li·ªáu!', 'error');
                return;
            }
            
            // Parse first month to get startYear and startMonth
            // Format: "2025-08" -> year=2025, month=8
            const firstMonth = monthsWithData[0].month;
            const [firstYear, firstMonthNum] = firstMonth.split('-').map(Number);
            
            // Set start year and month
            startYear = firstYear;
            startMonth = firstMonthNum;
            
            // Set total months based on data
            totalMonths = monthsWithData.length;
            currentPage = 1;
            
            // Clear cache
            monthDataCache = {};
            
            // Import data into cache
            monthsWithData.forEach((m, index) => {
                monthDataCache[`load${index}`] = m.load.toFixed(1);
                monthDataCache[`grid${index}`] = m.grid.toFixed(1);
                monthDataCache[`backup${index}`] = m.backup.toFixed(1);
            });
            
            // Reinitialize inputs with new month count
            initializeInputs();
            
            // Fill data into inputs (for current visible page)
            const startIndex = (currentPage - 1) * MONTHS_PER_PAGE;
            const endIndex = Math.min(startIndex + MONTHS_PER_PAGE, totalMonths);
            
            for (let i = startIndex; i < endIndex; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) loadEl.value = monthDataCache[`load${i}`] || '0';
                if (gridEl) gridEl.value = monthDataCache[`grid${i}`] || '0';
                if (backupEl) backupEl.value = monthDataCache[`backup${i}`] || '0';
            }
            
            // Close modal and calculate
            closeLumentreeModal();
            calculateSavings();
            saveSettings(true);
            
            // Show success with details
            const lastMonth = monthsWithData[monthsWithData.length - 1].month;
            const [lastYear, lastMonthNum] = lastMonth.split('-').map(Number);
            showNotification(`‚úÖ ƒê√£ nh·∫≠p ${monthsWithData.length} th√°ng (${firstMonthNum}/${firstYear} - ${lastMonthNum}/${lastYear}) t·ª´ Lumentree!`, 'success');
        }
        
        // Close modal on click outside
        document.getElementById('lumentreeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLumentreeModal();
            }
        });
        
        // Enter key to fetch
        document.getElementById('lumentreeDeviceId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchLumentreeData();
            }
        });
        
        // Tab switching
        function switchLumentreeTab(tab) {
            const tabDashboard = document.getElementById('lumentreeTabDashboard');
            const tabAuto = document.getElementById('lumentreeTabAuto');
            const tabManual = document.getElementById('lumentreeTabManual');
            const btnDashboard = document.getElementById('tabDashboard');
            const btnAuto = document.getElementById('tabAuto');
            const btnManual = document.getElementById('tabManual');
            
            // Reset all tabs
            tabDashboard.style.display = 'none';
            tabAuto.style.display = 'none';
            tabManual.style.display = 'none';
            btnDashboard.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            btnAuto.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            btnManual.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            
            // Sync device IDs
            const dashboardDeviceId = document.getElementById('dashboardDeviceId').value.trim();
            const autoDeviceId = document.getElementById('lumentreeDeviceId').value.trim();
            const manualDeviceId = document.getElementById('manualDeviceId').value.trim();
            const currentId = dashboardDeviceId || autoDeviceId || manualDeviceId;
            
            if (tab === 'dashboard') {
                tabDashboard.style.display = 'block';
                btnDashboard.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                if (currentId) document.getElementById('dashboardDeviceId').value = currentId;
            } else if (tab === 'auto') {
                tabAuto.style.display = 'block';
                btnAuto.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                if (currentId) document.getElementById('lumentreeDeviceId').value = currentId;
            } else {
                tabManual.style.display = 'block';
                btnManual.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                if (currentId) document.getElementById('manualDeviceId').value = currentId;
            }
            
            // Hide result section when switching
            document.getElementById('lumentreeResultSection').classList.remove('show');
        }
        
        // Fetch data from local Dashboard API (proxy to lumentree.net)
        async function fetchDashboardData() {
            const deviceId = document.getElementById('dashboardDeviceId').value.trim().toUpperCase();
            
            if (!deviceId) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Device ID!', 'error');
                return;
            }
            
            // Save device ID
            localStorage.setItem('lumentreeDeviceId', deviceId);
            document.getElementById('lumentreeDeviceId').value = deviceId;
            document.getElementById('manualDeviceId').value = deviceId;
            
            try {
                showNotification(`üîÑ ƒêang l·∫•y d·ªØ li·ªáu t·ª´ Lumentree qua Dashboard...`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(`/device/${deviceId}/monthly`);
                
                if (!response.ok) {
                    throw new Error(`Server tr·∫£ v·ªÅ l·ªói: ${response.status}`);
                }
                
                const data = await response.json();
                const elapsed = Date.now() - startTime;
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã n√†y');
                }
                
                lumentreeData = data;
                
                // Filter only months with data
                const monthsWithData = data.filter(m => m.load > 0 || m.grid > 0 || m.pv > 0);
                
                // Display preview
                let previewHtml = `
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 1.1em; font-weight: bold; color: #f59e0b; margin-bottom: 10px;">
                            ‚ö° Proxy: ${deviceId}
                        </div>
                        <div style="color: #cbd5e0;">
                            üìÖ T√¨m th·∫•y <strong>${monthsWithData.length}</strong> th√°ng c√≥ d·ªØ li·ªáu (${elapsed}ms)
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: rgba(245, 158, 11, 0.2);">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #f59e0b;">Th√°ng</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Load</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Grid</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">PV</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Backup</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(m => {
                    const hasData = m.load > 0 || m.grid > 0 || m.pv > 0;
                    const rowStyle = hasData ? '' : 'opacity: 0.4;';
                    previewHtml += `
                        <tr style="${rowStyle}">
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568;">${m.month}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.load.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.grid.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right; color: #f59e0b;">${m.pv.toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${m.backup.toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                previewHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('lumentreePreview').innerHTML = previewHtml;
                document.getElementById('lumentreeResultSection').classList.add('show');
                
                showNotification(`‚úÖ ƒê√£ l·∫•y ${monthsWithData.length} th√°ng t·ª´ Lumentree (${elapsed}ms)!`, 'success');
                
            } catch (error) {
                console.error('Dashboard fetch error:', error);
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }
        
        // Enter key handler for dashboard device ID
        document.getElementById('dashboardDeviceId')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchDashboardData();
            }
        });
        
        // Parse manual JSON input
        function parseManualLumentreeData() {
            const jsonInput = document.getElementById('lumentreeJsonInput').value.trim();
            
            if (!jsonInput) {
                showNotification('‚ö†Ô∏è Vui l√≤ng paste d·ªØ li·ªáu JSON!', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(jsonInput);
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('D·ªØ li·ªáu ph·∫£i l√† m·ªôt m·∫£ng JSON');
                }
                
                // Validate data structure
                const firstItem = data[0];
                if (!firstItem.month || firstItem.load === undefined) {
                    throw new Error('D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Lumentree');
                }
                
                lumentreeData = data;
                
                // Display preview (reuse the same preview function)
                const monthsWithData = data.filter(m => m.load > 0 || m.grid > 0 || m.pv > 0);
                
                let previewHtml = `
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 1.1em; font-weight: bold; color: #f59e0b; margin-bottom: 10px;">
                            üìã D·ªØ li·ªáu t·ª´ JSON
                        </div>
                        <div style="color: #cbd5e0;">
                            üìÖ T√¨m th·∫•y <strong>${monthsWithData.length}</strong> th√°ng c√≥ d·ªØ li·ªáu
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: rgba(245, 158, 11, 0.2);">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #f59e0b;">Th√°ng</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Load</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Grid</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">PV</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #f59e0b;">Backup</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(m => {
                    const hasData = (m.load || 0) > 0 || (m.grid || 0) > 0 || (m.pv || 0) > 0;
                    const rowStyle = hasData ? '' : 'opacity: 0.4;';
                    previewHtml += `
                        <tr style="${rowStyle}">
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568;">${m.month}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${(m.load || 0).toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${(m.grid || 0).toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right; color: #f59e0b;">${(m.pv || 0).toFixed(1)}</td>
                            <td style="padding: 6px 8px; border-bottom: 1px solid #4a5568; text-align: right;">${(m.backup || 0).toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                previewHtml += `</tbody></table></div>`;
                
                document.getElementById('lumentreePreview').innerHTML = previewHtml;
                document.getElementById('lumentreeResultSection').classList.add('show');
                
                showNotification(`‚úÖ ƒê√£ x·ª≠ l√Ω ${monthsWithData.length} th√°ng d·ªØ li·ªáu!`, 'success');
                
            } catch (error) {
                console.error('JSON parse error:', error);
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }
        // ==================== END LUMENTREE SYNC ====================
        
        // ==================== TOGGLE FUNCTIONS ====================
        function toggleProjectOverview() {
            const content = document.getElementById('projectOverviewContent');
            const btn = document.getElementById('toggleProjectOverviewBtn');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'üîΩ M·ªü';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }
        
        function toggleQuickStats() {
            const content = document.getElementById('quickStatsContent');
            const btn = document.getElementById('toggleQuickStatsBtn');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'üîΩ M·ªü';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }
        
        function toggleMonthInputs() {
            const content = document.getElementById('monthInputsContainer');
            const btn = document.getElementById('toggleBtn');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'üîΩ M·ªü';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }
        
        function toggleMonthDetails() {
            const content = document.getElementById('monthDetailsContainer');
            const btn = document.getElementById('toggleDetailsBtn');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'üîΩ M·ªü';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }
        // ==================== END TOGGLE FUNCTIONS ====================
    </script>
</body>
</html>
